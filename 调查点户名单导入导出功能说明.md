# 调查点户名单导入导出功能说明

## 功能概述

已成功在数据导入模块中增加了"调查点户名单"的导入导出功能，支持Excel格式的数据交换，实现了完整的数据管理流程。

## 功能特性

### 1. 导出功能
- **文件格式**：Excel (.xlsx)
- **数据来源**：从数据库中的"调查点户名单"表导出所有数据
- **包含字段**：
  - 户代码（主键）
  - 户主姓名
  - 人数
  - 所在乡镇街道
  - 村居名称
  - 创建时间
  - 更新时间
- **文件命名**：自动生成带时间戳的文件名（如：调查点户名单_20250909_014826.xlsx）
- **格式化**：应用专业的Excel格式，包括表头样式、边框、列宽自适应等

### 2. 导入功能
- **文件格式**：支持Excel (.xlsx, .xls)
- **操作模式**：智能UPSERT操作
  - 根据户代码判断是新增还是更新
  - 新户代码：插入新记录
  - 已存在户代码：更新现有记录
- **必需字段**：户代码、户主姓名
- **可选字段**：人数（默认1）、所在乡镇街道、村居名称
- **数据验证**：
  - 文件格式验证
  - 文件大小限制（50MB）
  - 必需字段检查
  - 数据类型转换和清理
- **错误处理**：详细的错误报告，包括具体行号和错误原因

### 3. 用户界面
- **位置**：主页 → 数据导入模块
- **界面元素**：
  - 导出按钮：一键导出当前数据库中的所有户名单数据
  - 导入按钮：选择Excel文件进行导入
  - 功能说明：详细的使用指南和字段要求
- **交互体验**：
  - 确认对话框：导入前显示文件信息和确认提示
  - 进度提示：显示处理状态
  - 结果反馈：详细的导入结果统计

## 技术实现

### 1. 后端实现
- **框架**：Flask蓝图架构
- **文件位置**：`src/blueprints/data_import.py`
- **新增端点**：
  - `GET /export_household_list`：导出功能
  - `POST /import_household_list`：导入功能
- **数据库操作**：使用SQLite连接池，支持事务处理
- **Excel处理**：集成openpyxl库，支持格式化输出

### 2. 前端实现
- **文件位置**：`src/templates/index.html`
- **JavaScript函数**：
  - `exportHouseholdList()`：处理导出操作
  - `importHouseholdList()`：处理导入操作
- **样式支持**：新增按钮组和表单帮助信息样式

### 3. 数据处理流程
```
导出流程：
数据库查询 → DataFrame转换 → Excel格式化 → 文件生成 → 下载响应

导入流程：
文件上传 → 格式验证 → Excel读取 → 数据清理 → 数据库UPSERT → 结果反馈
```

## 使用方法

### 导出操作
1. 进入主页，切换到"数据导入"模块
2. 在"调查点户名单管理"卡片中点击"导出户名单"按钮
3. 系统自动生成Excel文件并开始下载

### 导入操作
1. 准备Excel文件，确保包含必需字段：户代码、户主姓名
2. 点击"选择Excel文件导入"按钮，选择要导入的文件
3. 系统显示确认对话框，包含文件信息
4. 确认后开始导入，系统显示详细的处理结果

## 数据安全与完整性

### 1. 数据验证
- 户代码唯一性检查
- 必需字段完整性验证
- 数据类型自动转换
- 重复数据处理

### 2. 错误处理
- 文件格式错误提示
- 数据验证失败详情
- 逐行错误记录
- 事务回滚保护

### 3. 操作日志
- 详细的操作日志记录
- 导入导出统计信息
- 错误追踪和调试信息

## 测试验证

已完成全面测试，包括：
- ✅ 导出功能：成功导出562条记录
- ✅ 导入功能：成功导入3条测试记录（2条新增，1条更新）
- ✅ 数据完整性：验证更新操作正确执行
- ✅ 错误处理：文件格式、大小限制等验证正常
- ✅ 用户界面：交互流程顺畅，提示信息清晰

## 性能特点

- **高效处理**：使用pandas批量处理数据
- **内存优化**：流式处理大文件
- **并发安全**：数据库连接池支持
- **格式美观**：专业的Excel格式输出

## 扩展性

该功能设计具有良好的扩展性：
- 可轻松添加新的字段支持
- 支持不同的文件格式扩展
- 可集成数据验证规则
- 支持批量操作优化

---

**实现完成时间**：2025年9月9日  
**功能状态**：已完成并通过测试  
**维护说明**：功能稳定，可投入生产使用
