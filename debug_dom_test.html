<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DOM测试页面</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .test-section { margin: 20px 0; padding: 15px; border: 1px solid #ddd; }
        .success { color: green; }
        .error { color: red; }
        .info { color: blue; }
        .analysis-results { 
            margin-top: 20px; 
            padding: 15px; 
            border: 2px solid #007bff; 
            background: #f8f9fa;
            display: none;
        }
        button { margin: 5px; padding: 10px 15px; }
    </style>
</head>
<body>
    <h1>深度分析DOM测试页面</h1>
    
    <div class="test-section">
        <h2>1. DOM元素检测</h2>
        <button onclick="testDOMElements()">检测DOM元素</button>
        <div id="domTestResult"></div>
    </div>
    
    <div class="test-section">
        <h2>2. 模拟分析结果显示</h2>
        <button onclick="testResultDisplay()">测试结果显示</button>
        <div class="analysis-results" id="analysisResults">
            <!-- 测试结果容器 -->
        </div>
    </div>
    
    <div class="test-section">
        <h2>3. 实际API调用测试</h2>
        <button onclick="testAPICall()">调用分析API</button>
        <div id="apiTestResult"></div>
    </div>

    <script>
        // 格式化货币
        function formatCurrency(amount) {
            if (amount === null || amount === undefined) return '¥0.00';
            return '¥' + parseFloat(amount).toLocaleString('zh-CN', {
                minimumFractionDigits: 2,
                maximumFractionDigits: 2
            });
        }

        // 获取质量等级对应的CSS类
        function getQualityClass(level) {
            const classMap = {
                '优秀': 'excellent',
                '良好': 'good',
                '一般': 'average',
                '较差': 'poor',
                '很差': 'very-poor'
            };
            return classMap[level] || 'unknown';
        }

        // 生成消费画像标签表格
        function generateConsumptionProfileTable(profile) {
            if (!profile) {
                return '<p>暂无消费画像数据</p>';
            }

            let html = '<table border="1"><tbody>';
            for (const [tagType, tags] of Object.entries(profile)) {
                if (Array.isArray(tags) && tagType.endsWith('标签')) {
                    html += `
                        <tr>
                            <td><strong>${tagType}</strong></td>
                            <td>${tags.map(tag => `<span style="background:#007bff;color:white;padding:2px 6px;margin:2px;border-radius:3px;">${tag}</span>`).join('')}</td>
                        </tr>
                    `;
                }
            }
            html += '</tbody></table>';
            return html;
        }

        // 生成记账质量评估表格
        function generateQualityAssessmentTable(qualityData) {
            if (!qualityData) {
                return '<p>暂无质量评估数据</p>';
            }

            return `
                <table border="1">
                    <tbody>
                        <tr>
                            <td><strong>质量等级</strong></td>
                            <td><span style="background:#28a745;color:white;padding:2px 8px;border-radius:4px;">${qualityData.质量评估 || 'N/A'}</span></td>
                            <td><strong>总评分</strong></td>
                            <td><strong>${qualityData.总评分 || 0}</strong></td>
                        </tr>
                    </tbody>
                </table>
            `;
        }

        // 生成异常检测结果表格
        function generateAnomalyDetectionTable(anomalyData) {
            if (!anomalyData) {
                return '<p>暂无异常检测数据</p>';
            }

            const stats = anomalyData.异常统计 || {};
            return `
                <table border="1">
                    <tbody>
                        <tr>
                            <td><strong>异常记录数</strong></td>
                            <td><span style="color:#fd7e14;font-weight:600;">${stats.异常记录数 || 0}</span></td>
                            <td><strong>异常评分</strong></td>
                            <td><span style="color:#fd7e14;font-weight:600;">${stats.异常评分 || 0}</span></td>
                        </tr>
                    </tbody>
                </table>
            `;
        }

        // 显示单户分析结果
        function displaySingleAnalysisResult(data) {
            console.log('displaySingleAnalysisResult called with data:', data);
            const resultsContainer = document.getElementById('analysisResults');
            console.log('resultsContainer found:', resultsContainer);

            if (!resultsContainer) {
                console.error('analysisResults container not found!');
                return;
            }

            const basicInfo = data.household_basic_info || {};
            const comprehensive = data.comprehensive_assessment || {};

            const html = `
                <div style="margin-bottom:20px;padding-bottom:15px;border-bottom:2px solid #e9ecef;">
                    <h4>单户深度分析结果</h4>
                    <div>
                        <span>户代码: ${basicInfo.户代码 || 'N/A'}</span> | 
                        <span>户主: ${basicInfo.户主姓名 || 'N/A'}</span> | 
                        <span>村居: ${basicInfo.村居名称 || 'N/A'}</span>
                    </div>
                </div>

                <div>
                    <div style="margin:15px 0;padding:15px;background:#f8f9fa;">
                        <h5>基本信息</h5>
                        <table border="1" style="width:100%;">
                            <tbody>
                                <tr>
                                    <td><strong>户代码</strong></td>
                                    <td>${basicInfo.户代码 || 'N/A'}</td>
                                    <td><strong>户主姓名</strong></td>
                                    <td>${basicInfo.户主姓名 || 'N/A'}</td>
                                </tr>
                                <tr>
                                    <td><strong>总收入</strong></td>
                                    <td>${formatCurrency(basicInfo.总收入 || 0)}</td>
                                    <td><strong>总支出</strong></td>
                                    <td>${formatCurrency(basicInfo.总支出 || 0)}</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>

                    <div style="margin:15px 0;padding:15px;background:#f8f9fa;">
                        <h5>消费画像标签</h5>
                        ${generateConsumptionProfileTable(data.consumption_profile)}
                    </div>

                    <div style="margin:15px 0;padding:15px;background:#f8f9fa;">
                        <h5>记账质量评估</h5>
                        ${generateQualityAssessmentTable(data.quality_assessment)}
                    </div>

                    <div style="margin:15px 0;padding:15px;background:#f8f9fa;">
                        <h5>综合评估</h5>
                        <table border="1" style="width:100%;">
                            <tbody>
                                <tr>
                                    <td><strong>综合等级</strong></td>
                                    <td><span style="background:#28a745;color:white;padding:2px 8px;border-radius:4px;">${comprehensive.综合等级 || 'N/A'}</span></td>
                                    <td><strong>综合评分</strong></td>
                                    <td><strong>${comprehensive.综合评分 || 0}</strong></td>
                                </tr>
                                <tr>
                                    <td><strong>评估描述</strong></td>
                                    <td colspan="3">${comprehensive.评估描述 || '暂无描述'}</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>

                    <div style="margin:15px 0;padding:15px;background:#f8f9fa;">
                        <h5>异常检测结果</h5>
                        ${generateAnomalyDetectionTable(data.anomaly_detection)}
                    </div>
                </div>
            `;

            console.log('Setting innerHTML...');
            resultsContainer.innerHTML = html;
            console.log('Setting display to block...');
            resultsContainer.style.display = 'block';
            console.log('displaySingleAnalysisResult completed');
        }

        // 测试DOM元素
        function testDOMElements() {
            const resultDiv = document.getElementById('domTestResult');
            let html = '<h3>DOM元素检测结果：</h3>';

            // 检测analysisResults元素
            const analysisResults = document.getElementById('analysisResults');
            if (analysisResults) {
                html += '<p class="success">✅ analysisResults元素存在</p>';
                html += `<p class="info">- 元素类型: ${analysisResults.tagName}</p>`;
                html += `<p class="info">- 当前display样式: ${getComputedStyle(analysisResults).display}</p>`;
                html += `<p class="info">- 内联样式: ${analysisResults.style.cssText}</p>`;
            } else {
                html += '<p class="error">❌ analysisResults元素不存在</p>';
            }

            resultDiv.innerHTML = html;
        }

        // 测试结果显示
        function testResultDisplay() {
            const mockData = {
                household_basic_info: {
                    户代码: '321283001002012',
                    户主姓名: '测试户主',
                    村居名称: '测试村',
                    家庭人口: 3,
                    总收入: 50000,
                    总支出: 30000
                },
                consumption_profile: {
                    消费水平型标签: ['高消费户'],
                    消费偏好型标签: ['爱宠家庭', '健康生活']
                },
                quality_assessment: {
                    质量评估: '优秀',
                    总评分: 95
                },
                comprehensive_assessment: {
                    综合等级: '优秀',
                    综合评分: 95,
                    评估描述: '记账质量优秀，数据可靠性高'
                },
                anomaly_detection: {
                    异常统计: {
                        异常记录数: 5,
                        异常评分: 2.5
                    }
                }
            };

            displaySingleAnalysisResult(mockData);
        }

        // 测试API调用
        async function testAPICall() {
            const resultDiv = document.getElementById('apiTestResult');
            resultDiv.innerHTML = '正在调用API...';

            try {
                const response = await fetch('/api/household-analysis/single', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        household_code: '321283001002012'
                    })
                });

                const result = await response.json();

                if (result.success) {
                    resultDiv.innerHTML = `
                        <p class="success">✅ API调用成功</p>
                        <p>户代码: ${result.data.household_basic_info?.户代码}</p>
                        <p>户主姓名: ${result.data.household_basic_info?.户主姓名}</p>
                        <button onclick="displaySingleAnalysisResult(${JSON.stringify(result.data).replace(/"/g, '&quot;')})">显示分析结果</button>
                    `;
                } else {
                    resultDiv.innerHTML = `<p class="error">❌ API调用失败: ${result.message}</p>`;
                }
            } catch (error) {
                resultDiv.innerHTML = `<p class="error">❌ 请求失败: ${error.message}</p>`;
            }
        }
    </script>
</body>
</html>
