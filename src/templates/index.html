<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ä½æˆ·æ•°æ®æ•´ç†ç³»ç»Ÿ</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/styles.css') }}">
    <!-- æ·»åŠ Font Awesomeå›¾æ ‡åº“ -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>
<body>
    <!-- åŠ è½½é®ç½© -->
    <div id="loadingOverlay" class="loading-overlay">
        <div class="loading-spinner">
            <i class="fas fa-spinner fa-spin"></i>
            <p id="loadingText">æ­£åœ¨å¤„ç†ä¸­...</p>
        </div>
    </div>

    <!-- æ¶ˆæ¯æç¤º -->
    <div id="messageContainer" class="message-container"></div>

    <!-- ä¸»å®¹å™¨ -->
    <div class="container">
        <header class="header">
            <div class="header-content">
                <h1><i class="fas fa-home"></i> ä½æˆ·æ•°æ®æ•´ç†ç³»ç»Ÿ</h1>
                <p class="subtitle">é«˜æ•ˆã€å®‰å…¨çš„ä½æˆ·è°ƒæŸ¥æ•°æ®ç®¡ç†å¹³å°</p>
            </div>
            <!-- ç³»ç»ŸçŠ¶æ€æŒ‡ç¤ºå™¨ -->
            <div class="system-status">
                <div class="status-item">
                    <i class="fas fa-database"></i>
                    <span>æ•°æ®åº“è¿æ¥</span>
                    <div class="status-indicator" id="dbStatus"></div>
                </div>
                <div class="status-item">
                    <i class="fas fa-clock"></i>
                    <span>ç³»ç»Ÿæ—¶é—´</span>
                    <div class="status-time" id="systemTime"></div>
                </div>
            </div>
        </header>

        <!-- å¯¼èˆªèœå• -->
        <nav class="main-nav">
            <div class="nav-item active" data-section="data-generation">
                <i class="fas fa-chart-line"></i>
                <span>æ•°æ®ç”Ÿæˆ</span>
            </div>
            <div class="nav-item" data-section="data-import">
                <i class="fas fa-upload"></i>
                <span>æ•°æ®å¯¼å…¥</span>
            </div>


            <div class="nav-item" data-section="statistics">
                <i class="fas fa-chart-bar"></i>
                <span>æ•°æ®ç»Ÿè®¡</span>
            </div>

        </nav>

        <!-- æ•°æ®ç”Ÿæˆæ¨¡å— -->
        <section class="module-section active" id="data-generation">
            <div class="section-header">
                <h2><i class="fas fa-chart-line"></i> æ•°æ®ç”Ÿæˆ</h2>
                <p class="section-description">ç”Ÿæˆå„ç±»æ•°æ®æŠ¥è¡¨å’Œå°è´¦æ–‡ä»¶</p>
            </div>



            <div class="form-card">
                <div class="card-header">
                    <h3><i class="fas fa-table"></i> ç”Ÿæˆç”µå­å°è´¦</h3>
                    <div class="card-status">
                        <span class="status-badge ready">å°±ç»ª</span>
                    </div>
                </div>
                <form id="ledgerForm" action="/generate_electronic_ledger" method="post" target="_blank">
                    <div class="form-row">
                        <div class="form-group">
                            <label for="ledger_year">å¹´åº¦ï¼š</label>
                            <select name="year" id="ledger_year" required>
                                <option value="2023">2023</option>
                                <option value="2024">2024</option>
                                <option value="2025">2025</option>
                                <option value="2026">2026</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="ledger_month">æœˆä»½ï¼š</label>
                            <select name="month" id="ledger_month" required>
                                <option value="01">01æœˆ</option>
                                <option value="02">02æœˆ</option>
                                <option value="03">03æœˆ</option>
                                <option value="04">04æœˆ</option>
                                <option value="05">05æœˆ</option>
                                <option value="06">06æœˆ</option>
                                <option value="07">07æœˆ</option>
                                <option value="08">08æœˆ</option>
                                <option value="09">09æœˆ</option>
                                <option value="10">10æœˆ</option>
                                <option value="11">11æœˆ</option>
                                <option value="12">12æœˆ</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="town">ä¹¡é•‡ï¼š</label>
                            <select name="town" id="town" required>
                                <option value="å…¨éƒ¨ä¹¡é•‡">å…¨éƒ¨ä¹¡é•‡</option>
                                <option value="åˆ†ç•Œé•‡">åˆ†ç•Œé•‡</option>
                                <option value="æ»¨æ±Ÿé•‡">æ»¨æ±Ÿé•‡</option>
                                <option value="é»„æ¡¥é•‡">é»„æ¡¥é•‡</option>
                                <option value="å»¶ä»¤æµå·è¡—é“">å»¶ä»¤æµå·è¡—é“</option>
                                <option value="å¤æºªé•‡">å¤æºªé•‡</option>
                                <option value="å…ƒç«¹é•‡">å…ƒç«¹é•‡</option>
                                <option value="çŠç‘šé•‡">çŠç‘šé•‡</option>
                                <option value="æ›²éœé•‡">æ›²éœé•‡</option>
                                <option value="å¹¿é™µé•‡">å¹¿é™µé•‡</option>
                                <option value="å¼ æ¡¥é•‡">å¼ æ¡¥é•‡</option>
                                <option value="æ²³å¤±é•‡">æ²³å¤±é•‡</option>
                                <option value="æ–°è¡—é•‡">æ–°è¡—é•‡</option>
                                <option value="å§šç‹è¡—é“">å§šç‹è¡—é“</option>
                                <option value="å®£å ¡é•‡">å®£å ¡é•‡</option>
                                <option value="è™¹æ¡¥é•‡">è™¹æ¡¥é•‡</option>
                                <option value="æ ¹æ€ä¹¡">æ ¹æ€ä¹¡</option>
                            </select>
                        </div>
                    </div>
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-download"></i> ç”Ÿæˆç”µå­å°è´¦
                    </button>
                </form>
            </div>

            <div class="form-card">
                <div class="card-header">
                    <h3><i class="fas fa-table"></i> ç”Ÿæˆæ±‡æ€»è¡¨</h3>
                    <div class="card-status">
                        <span class="status-badge ready">å°±ç»ª</span>
                    </div>
                </div>
                <form id="summaryForm" action="{{ url_for('data_generation.generate_summary_table') }}" method="post" target="_blank">
                    <div class="form-row">
                        <div class="form-group">
                            <label for="summary_year">å¹´ä»½ï¼š</label>
                            <select name="year" id="summary_year" required>
                                <option value="2023">2023</option>
                                <option value="2024" selected>2024</option>
                                <option value="2025">2025</option>
                                <option value="2026">2026</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="summary_period">æœŸåˆ«ï¼š</label>
                            <select name="period" id="summary_period" required>
                                <option value="ä¸€å­£åº¦">ä¸€å­£åº¦</option>
                                <option value="ä¸ŠåŠå¹´">ä¸ŠåŠå¹´</option>
                                <option value="ä¸‰å­£åº¦">ä¸‰å­£åº¦</option>
                                <option value="å…¨å¹´åº¦">å…¨å¹´åº¦</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="summary_category">ç±»åˆ«ï¼š</label>
                            <select name="category" id="summary_category" required>
                                <option value="å…¨éƒ¨">å…¨éƒ¨</option>
                                <option value="åŸé•‡ç‚¹">åŸé•‡ç‚¹</option>
                                <option value="å†œæ‘ç‚¹">å†œæ‘ç‚¹</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="summary_sample_point_type">æ ·æœ¬ç‚¹ç±»å‹ï¼š</label>
                            <select name="sample_point_type" id="summary_sample_point_type" required>
                                <option value="å…¨éƒ¨ç±»å‹" selected>å…¨éƒ¨ç±»å‹</option>
                                <option value="å›½å®¶ç‚¹">å›½å®¶ç‚¹</option>
                            </select>
                        </div>
                    </div>
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-download"></i> ç”Ÿæˆæ±‡æ€»è¡¨
                    </button>
                </form>
            </div>
        </section>

        <!-- æ•°æ®å¯¼å…¥æ¨¡å— -->
        <section class="module-section" id="data-import">
            <div class="section-header">
                <h2><i class="fas fa-upload"></i> æ•°æ®å¯¼å…¥</h2>
                <p class="section-description">å¯¼å…¥å„ç±»Excelæ•°æ®æ–‡ä»¶åˆ°ç³»ç»Ÿæ•°æ®åº“</p>
            </div>



            <div class="form-card">
                <div class="card-header">
                    <h3><i class="fas fa-flag"></i> å¯¼å…¥å›½å®¶ç‚¹æ•°æ®</h3>
                    <div class="card-status">
                        <span class="status-badge ready">å°±ç»ª</span>
                    </div>
                </div>
                <form id="nationalForm" action="/import_national_data" method="post" enctype="multipart/form-data">
                    <div class="file-upload-area">
                        <input type="file" name="file" id="import_national_file" accept=".csv" required>
                        <label for="import_national_file" class="file-upload-label">
                            <i class="fas fa-cloud-upload-alt"></i>
                            <span>é€‰æ‹©CSVæ–‡ä»¶æˆ–æ‹–æ‹½åˆ°æ­¤å¤„</span>
                            <small>æ”¯æŒ .csv æ ¼å¼ï¼Œæœ€å¤§50MB</small>
                        </label>
                    </div>
                    <button type="submit" class="btn btn-success">
                        <i class="fas fa-upload"></i> å¯¼å…¥å›½å®¶ç‚¹æ•°æ®
                    </button>
                </form>
            </div>
        </section>






    </div>

    <!-- ç¡®è®¤å¯¹è¯æ¡† -->
    <div id="confirmModal" class="modal" style="display: none;">
        <div class="modal-content">
            <h3><i class="fas fa-exclamation-triangle"></i> ç¡®è®¤æ“ä½œ</h3>
            <p id="confirmMessage">æ‚¨ç¡®å®šè¦æ‰§è¡Œæ­¤æ“ä½œå—ï¼Ÿ</p>
            <div class="modal-buttons">
                <button id="confirmYes" class="btn btn-primary">ç¡®è®¤</button>
                <button id="confirmNo" class="btn btn-secondary">å–æ¶ˆ</button>
            </div>
        </div>
    </div>

    <script>
        // æ·»åŠ å…¨å±€é”™è¯¯å¤„ç†
        window.addEventListener('error', function(e) {
            console.error('å…¨å±€JavaScripté”™è¯¯:', e.error);
            console.error('é”™è¯¯ä½ç½®:', e.filename, 'è¡Œ:', e.lineno, 'åˆ—:', e.colno);
        });

        // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            console.log('DOMå†…å®¹åŠ è½½å®Œæˆï¼Œå¼€å§‹åˆå§‹åŒ–...');

            // æ·»åŠ ä¸€ä¸ªç®€å•çš„æµ‹è¯•æ¥éªŒè¯JavaScriptæ˜¯å¦å·¥ä½œ
            try {
                document.getElementById('totalMappings').textContent = 'æµ‹è¯•ä¸­...';
                console.log('âœ… åŸºç¡€DOMæ“ä½œæ­£å¸¸');
            } catch (error) {
                console.error('âŒ åŸºç¡€DOMæ“ä½œå¤±è´¥:', error);
            }

            try {
                console.log('1. åˆå§‹åŒ–é¡µé¢...');
                initializePage();

                console.log('2. è®¾ç½®è¡¨å•å¤„ç†å™¨...');
                setupFormHandlers();

                console.log('3. è®¾ç½®æ–‡ä»¶ä¸Šä¼ ...');
                setupFileUpload();

                console.log('4. è®¾ç½®å¯¼èˆª...');
                setupNavigation();

                console.log('5. æ›´æ–°ç³»ç»ŸçŠ¶æ€...');
                updateSystemStatus();

                console.log('6. å¯åŠ¨ç³»ç»Ÿæ—¶é—´æ›´æ–°...');
                startSystemTimeUpdate();



                console.log('é¡µé¢åˆå§‹åŒ–å®Œæˆï¼');
            } catch (error) {
                console.error('é¡µé¢åˆå§‹åŒ–å¤±è´¥:', error);
                // æ˜¾ç¤ºé”™è¯¯ä¿¡æ¯åˆ°é¡µé¢ä¸Š
                const errorDiv = document.createElement('div');
                errorDiv.style.cssText = 'position:fixed;top:10px;right:10px;background:red;color:white;padding:10px;z-index:9999;';
                errorDiv.textContent = 'é¡µé¢åˆå§‹åŒ–å¤±è´¥: ' + error.message;
                document.body.appendChild(errorDiv);
            }
        });

        // åˆå§‹åŒ–é¡µé¢
        function initializePage() {
            const currentYear = new Date().getFullYear();
            const currentMonth = (new Date().getMonth() + 1).toString().padStart(2, '0');

            // è®¾ç½®é»˜è®¤å¹´æœˆ
            const yearSelects = document.querySelectorAll('select[name="year"]');
            const monthSelects = document.querySelectorAll('select[name="month"]');

            yearSelects.forEach(select => {
                select.value = currentYear;
            });

            monthSelects.forEach(select => {
                select.value = currentMonth;
            });
        }

        // è®¾ç½®å¯¼èˆªåŠŸèƒ½
        function setupNavigation() {
            const navItems = document.querySelectorAll('.nav-item');
            const sections = document.querySelectorAll('.module-section');

            navItems.forEach(item => {
                item.addEventListener('click', function() {
                    const targetSection = this.getAttribute('data-section');

                    // ç‰¹æ®Šå¤„ç†ç»Ÿè®¡é¡µé¢ - è·³è½¬åˆ°æ–°é¡µé¢
                    if (targetSection === 'statistics') {
                        window.open('/statistics', '_blank');
                        return;
                    }



                    // æ›´æ–°å¯¼èˆªçŠ¶æ€
                    navItems.forEach(nav => nav.classList.remove('active'));
                    this.classList.add('active');

                    // æ˜¾ç¤ºå¯¹åº”çš„æ¨¡å—
                    sections.forEach(section => {
                        section.classList.remove('active');
                        if (section.id === targetSection) {
                            section.classList.add('active');
                        }
                    });
                });
            });
        }

        // æ›´æ–°ç³»ç»ŸçŠ¶æ€
        function updateSystemStatus() {
            const dbStatus = document.getElementById('dbStatus');

            // æ£€æŸ¥æ•°æ®åº“è¿æ¥çŠ¶æ€
            fetch('/api/system/status')
                .then(response => response.json())
                .then(data => {
                    if (data.database_connected) {
                        dbStatus.className = 'status-indicator online';
                        dbStatus.title = 'æ•°æ®åº“è¿æ¥æ­£å¸¸';
                    } else {
                        dbStatus.className = 'status-indicator offline';
                        dbStatus.title = 'æ•°æ®åº“è¿æ¥å¼‚å¸¸';
                    }
                })
                .catch(() => {
                    dbStatus.className = 'status-indicator offline';
                    dbStatus.title = 'æ— æ³•è·å–çŠ¶æ€';
                });
        }

        // å¼€å§‹ç³»ç»Ÿæ—¶é—´æ›´æ–°
        function startSystemTimeUpdate() {
            function updateTime() {
                const now = new Date();
                const timeString = now.getFullYear() + 'å¹´' +
                                 String(now.getMonth() + 1).padStart(2, '0') + 'æœˆ' +
                                 String(now.getDate()).padStart(2, '0') + 'æ—¥ ' +
                                 String(now.getHours()).padStart(2, '0') + ':' +
                                 String(now.getMinutes()).padStart(2, '0') + ':' +
                                 String(now.getSeconds()).padStart(2, '0');
                document.getElementById('systemTime').textContent = timeString;
            }

            updateTime();
            setInterval(updateTime, 1000);
        }

        // è®¾ç½®è¡¨å•å¤„ç†å™¨
        function setupFormHandlers() {
            // æ•°æ®ç”Ÿæˆè¡¨å•
            setupLedgerFormSubmit(); // ç”µå­å°è´¦ä½¿ç”¨ç‰¹æ®Šå¤„ç†
            setupFormSubmit('summaryForm', 'æ­£åœ¨ç”Ÿæˆæ±‡æ€»è¡¨...');

            // æ•°æ®å¯¼å…¥è¡¨å•
            setupFormSubmit('nationalForm', 'æ­£åœ¨å¯¼å…¥å›½å®¶ç‚¹æ•°æ®...', true);


        }

        // è®¾ç½®è¡¨å•æäº¤å¤„ç†
        function setupFormSubmit(formId, loadingText, needConfirm = false) {
            const form = document.getElementById(formId);
            if (!form) return;

            form.addEventListener('submit', function(e) {
                if (needConfirm) {
                    e.preventDefault();
                    showConfirmDialog(getConfirmMessage(formId), () => {
                        submitForm(form, loadingText);
                    });
                } else {
                    e.preventDefault();
                    submitForm(form, loadingText);
                }
            });
        }

        // è·å–ç¡®è®¤æ¶ˆæ¯
        function getConfirmMessage(formId) {
            const form = document.getElementById(formId);
            let baseMessage = '';

            const messages = {
                'nationalForm': 'ç¡®å®šè¦å¯¼å…¥å›½å®¶ç‚¹æ•°æ®å—ï¼Ÿæ­¤æ“ä½œå°†å‘æ•°æ®åº“æ·»åŠ æ–°è®°å½•ã€‚'
            };
            baseMessage = messages[formId] || 'ç¡®å®šè¦æ‰§è¡Œæ­¤æ“ä½œå—ï¼Ÿ';

            // æ£€æŸ¥æ–‡ä»¶å¤§å°å¹¶æ·»åŠ è­¦å‘Š
            if (form) {
                const fileInput = form.querySelector('input[type="file"]');
                if (fileInput && fileInput.files.length > 0) {
                    const file = fileInput.files[0];
                    const fileSizeMB = file.size / (1024 * 1024);
                    if (fileSizeMB > 10) {
                        baseMessage += `\n\næ³¨æ„ï¼šæ‚¨é€‰æ‹©çš„æ–‡ä»¶è¾ƒå¤§ï¼ˆ${fileSizeMB.toFixed(1)}MBï¼‰ï¼Œå¤„ç†æ—¶é—´å¯èƒ½è¾ƒé•¿ï¼Œè¯·è€å¿ƒç­‰å¾…ã€‚`;
                    }
                }
            }

            return baseMessage;
        }

        // æäº¤è¡¨å• - ä¼˜åŒ–ç‰ˆæ”¯æŒå¼‚æ­¥å¤„ç†å’Œè¿›åº¦åé¦ˆ
        function submitForm(form, loadingText) {
            const formId = form.getAttribute('id');
            
            // æ£€æŸ¥æ˜¯å¦ä¸ºå¤§æ–‡ä»¶ä¸Šä¼ ï¼Œå¯ç”¨ç‰¹æ®Šå¤„ç†
            const fileInput = form.querySelector('input[type="file"]');
            const isLargeFileUpload = fileInput && fileInput.files[0] && fileInput.files[0].size > 10 * 1024 * 1024; // 10MB

            if (formId === 'nationalForm' || isLargeFileUpload) {
                submitFormWithProgress(form, loadingText);
            } else {
                submitFormNormal(form, loadingText);
            }
        }

        // æ™®é€šè¡¨å•æäº¤ï¼ˆä¿æŒåŸæœ‰é€»è¾‘ï¼‰
        function submitFormNormal(form, loadingText) {
            showLoading(loadingText);

            const formData = new FormData(form);
            const action = form.getAttribute('action');
            const method = form.getAttribute('method') || 'POST';

            // åˆ›å»ºAbortControllerç”¨äºè¶…æ—¶æ§åˆ¶
            const controller = new AbortController();
            const timeoutId = setTimeout(() => {
                controller.abort();
            }, 300000); // 5åˆ†é’Ÿè¶…æ—¶

            fetch(action, {
                method: method,
                body: formData,
                signal: controller.signal
            })
            .then(response => {
                // æ£€æŸ¥å†…å®¹ç±»å‹
                const contentType = response.headers.get('content-type');

                if (contentType && contentType.includes('application/json')) {
                    // å¤„ç†JSONå“åº”
                    return response.json().then(data => {
                        showMessage(data.message || 'æ“ä½œå®Œæˆ', data.success ? 'success' : 'error');
                    });
                } else if (contentType && contentType.includes('application/')) {
                    // å¤„ç†æ–‡ä»¶ä¸‹è½½
                    if (response.ok) {
                        return response.blob().then(blob => {
                            const url = window.URL.createObjectURL(blob);
                            const a = document.createElement('a');
                            a.href = url;

                            // å°è¯•ä»å“åº”å¤´è·å–æ–‡ä»¶å
                            let filename = getFileNameFromResponse(response, action);
                            a.download = filename;

                            document.body.appendChild(a);
                            a.click();
                            window.URL.revokeObjectURL(url);
                            document.body.removeChild(a);
                            showMessage('æ–‡ä»¶ç”ŸæˆæˆåŠŸï¼', 'success');
                        });
                    } else {
                        return response.text().then(text => {
                            showMessage(text || 'æ–‡ä»¶ç”Ÿæˆå¤±è´¥', 'error');
                        });
                    }
                } else {
                    // å¤„ç†æ–‡æœ¬å“åº”
                    return response.text().then(text => {
                        showMessage(text || (response.ok ? 'æ“ä½œæˆåŠŸ' : 'æ“ä½œå¤±è´¥'), response.ok ? 'success' : 'error');
                    });
                }
            })
            .catch(error => {
                clearTimeout(timeoutId);
                if (error.name === 'AbortError') {
                    showMessage('æ“ä½œè¶…æ—¶ï¼Œè¯·æ£€æŸ¥æ–‡ä»¶å¤§å°æˆ–ç½‘ç»œè¿æ¥', 'error');
                } else {
                    showMessage('ç½‘ç»œé”™è¯¯ï¼š' + error.message, 'error');
                }
            })
            .finally(() => {
                clearTimeout(timeoutId);
                hideLoading();
            });
        }

        // å¸¦è¿›åº¦çš„å¼‚æ­¥è¡¨å•æäº¤ï¼ˆç”¨äºå¤§æ–‡ä»¶å¤„ç†ï¼‰
        function submitFormWithProgress(form, loadingText) {
            const formId = form.getAttribute('id');
            const action = form.getAttribute('action');
            const formData = new FormData(form);

            // æ˜¾ç¤ºå¸¦è¿›åº¦çš„åŠ è½½çŠ¶æ€
            showLoadingWithProgress(loadingText);

            // å¯åŠ¨è¿›åº¦ç›‘æ§
            let progressMonitor = null;
            let completedSuccessfully = false;

            // æäº¤è¡¨å•
            fetch(action, {
                method: 'POST',
                body: formData
            })
            .then(async response => {
                const contentType = response.headers.get('content-type');
                
                if (contentType && contentType.includes('application/json')) {
                    const data = await response.json();
                    completedSuccessfully = data.success || response.ok;
                    showMessage(data.message || 'æ“ä½œå®Œæˆ', completedSuccessfully ? 'success' : 'error');
                } else {
                    const text = await response.text();
                    completedSuccessfully = response.ok;
                    showMessage(text || (response.ok ? 'æ“ä½œæˆåŠŸ' : 'æ“ä½œå¤±è´¥'), response.ok ? 'success' : 'error');
                }
            })
            .catch(error => {
                completedSuccessfully = false;
                if (error.name === 'AbortError') {
                    showMessage('æ“ä½œå¯èƒ½å› æ–‡ä»¶è¿‡å¤§è€Œè¶…æ—¶ï¼Œä½†åå°ä»åœ¨å¤„ç†ä¸­', 'warning');
                } else {
                    showMessage('ç½‘ç»œé”™è¯¯ï¼š' + error.message, 'error');
                }
            })
            .finally(() => {
                if (progressMonitor) {
                    clearInterval(progressMonitor);
                }
                hideLoading();
            });

            // å¦‚æœæ˜¯å›½å®¶ç‚¹å¯¼å…¥ï¼Œå¯åŠ¨è¿›åº¦ç›‘æ§
            if (formId === 'nationalForm') {
                let progressStep = 0;
                const progressSteps = [
                    'æ­£åœ¨è¯»å–CSVæ–‡ä»¶...',
                    'æ­£åœ¨éªŒè¯æ•°æ®æ ¼å¼...',
                    'æ­£åœ¨å¯¼å…¥åˆ°ä¸´æ—¶è¡¨...',
                    'æ­£åœ¨éªŒè¯æ•°æ®å®Œæ•´æ€§...',
                    'æ­£åœ¨åˆå¹¶åˆ°ä¸»è¡¨...',
                    'æ­£åœ¨æ›´æ–°ç¼–ç ä¿¡æ¯...',
                    'æ­£åœ¨å®Œæˆæœ€åå¤„ç†...'
                ];

                progressMonitor = setInterval(() => {
                    if (!completedSuccessfully && progressStep < progressSteps.length - 1) {
                        progressStep++;
                        updateLoadingText(progressSteps[progressStep]);
                    }
                }, 15000); // æ¯15ç§’æ›´æ–°ä¸€æ¬¡è¿›åº¦æç¤º
            }
        }

        // ç”µå­å°è´¦è¡¨å•ç‰¹æ®Šå¤„ç†ï¼ˆæ”¯æŒè¿›åº¦åé¦ˆï¼‰
        function setupLedgerFormSubmit() {
            const form = document.getElementById('ledgerForm');
            if (!form) return;

            form.addEventListener('submit', function(e) {
                e.preventDefault();

                const formData = new FormData(form);
                const town = formData.get('town');

                // ç”Ÿæˆä»»åŠ¡ID
                const taskId = 'ledger_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
                formData.append('task_id', taskId);

                // ç¡®å®šåŠ è½½æ–‡æœ¬
                let loadingText;
                if (town === 'å…¨éƒ¨ä¹¡é•‡') {
                    loadingText = 'æ­£åœ¨å‡†å¤‡æ‰¹é‡ç”Ÿæˆç”µå­å°è´¦...';
                } else {
                    loadingText = `æ­£åœ¨ç”Ÿæˆ ${town} ç”µå­å°è´¦...`;
                }

                // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
                showLoadingWithProgress(loadingText);

                // å¯åŠ¨è¿›åº¦ç›‘æ§
                const progressMonitor = startLedgerProgressMonitor(taskId, town);

                // æäº¤è¡¨å•
                fetch(form.action, {
                    method: 'POST',
                    body: formData
                })
                .then(response => {
                    if (response.ok) {
                        return response.blob().then(blob => {
                            const fileName = getFileNameFromResponse(response, form.action);
                            downloadBlob(blob, fileName);
                            showMessage('ç”µå­å°è´¦ç”ŸæˆæˆåŠŸï¼', 'success');
                        });
                    } else {
                        return response.text().then(text => {
                            throw new Error(text || 'ç”Ÿæˆå¤±è´¥');
                        });
                    }
                })
                .catch(error => {
                    console.error('ç”µå­å°è´¦ç”Ÿæˆå¤±è´¥:', error);
                    showMessage('ç”Ÿæˆå¤±è´¥ï¼š' + error.message, 'error');
                })
                .finally(() => {
                    clearInterval(progressMonitor);
                    hideLoading();
                });
            });
        }

        // å¯åŠ¨ç”µå­å°è´¦è¿›åº¦ç›‘æ§
        function startLedgerProgressMonitor(taskId, town) {
            return setInterval(() => {
                fetch(`/ledger_progress/${taskId}`)
                .then(response => response.json())
                .then(data => {
                    if (data.success && data.progress) {
                        const progress = data.progress;
                        let progressText;

                        if (progress.status === 'processing') {
                            if (town === 'å…¨éƒ¨ä¹¡é•‡') {
                                progressText = `æ­£åœ¨ç”Ÿæˆ ${progress.current_town} ç”µå­å°è´¦... (${progress.current_index}/${progress.total_towns})`;
                            } else {
                                progressText = `æ­£åœ¨ç”Ÿæˆ ${progress.current_town} ç”µå­å°è´¦...`;
                            }
                        } else if (progress.status === 'completed') {
                            if (town === 'å…¨éƒ¨ä¹¡é•‡') {
                                progressText = `å…¨éƒ¨ä¹¡é•‡ç”µå­å°è´¦ç”Ÿæˆå®Œæˆï¼æ­£åœ¨æ‰“åŒ…ä¸‹è½½...`;
                            } else {
                                progressText = `${progress.current_town} ç”µå­å°è´¦ç”Ÿæˆå®Œæˆï¼æ­£åœ¨å‡†å¤‡ä¸‹è½½...`;
                            }
                        }

                        updateLoadingText(progressText);
                    }
                })
                .catch(error => {
                    console.warn('è·å–è¿›åº¦å¤±è´¥:', error);
                });
            }, 2000); // æ¯2ç§’æ£€æŸ¥ä¸€æ¬¡è¿›åº¦
        }

        // ä»å“åº”å¤´è·å–æ–‡ä»¶å
        function getFileNameFromResponse(response, action) {
            // å°è¯•ä»Content-Dispositionå¤´è·å–æ–‡ä»¶å
            const contentDisposition = response.headers.get('Content-Disposition');
            if (contentDisposition) {
                // ä¼˜å…ˆåŒ¹é… filename*=UTF-8''filename (RFC 5987æ ‡å‡†ï¼Œæ”¯æŒä¸­æ–‡)
                const utf8Match = contentDisposition.match(/filename\*=UTF-8''([^;]+)/);
                if (utf8Match) {
                    try {
                        return decodeURIComponent(utf8Match[1]);
                    } catch (e) {
                        console.warn('UTF-8æ–‡ä»¶åè§£ç å¤±è´¥:', e);
                    }
                }

                // å›é€€åˆ° filename="filename" (ASCIIå®‰å…¨)
                const asciiMatch = contentDisposition.match(/filename="([^"]+)"/);
                if (asciiMatch) {
                    return asciiMatch[1];
                }
            }

            // å›é€€åˆ°é»˜è®¤æ–‡ä»¶å
            return getDefaultFileName(action);
        }

        // è·å–é»˜è®¤æ–‡ä»¶å
        function getDefaultFileName(action) {

            if (action.includes('ledger')) return 'ç”µå­å°è´¦.xlsx';
            return 'download.xlsx';
        }

        // è®¾ç½®æ–‡ä»¶ä¸Šä¼ 
        function setupFileUpload() {
            const fileInputs = document.querySelectorAll('input[type="file"]');

            fileInputs.forEach(input => {
                const label = input.nextElementSibling;

                // æ–‡ä»¶é€‰æ‹©äº‹ä»¶
                input.addEventListener('change', function(e) {
                    const file = e.target.files[0];
                    if (file) {
                        updateFileLabel(label, file);
                        validateFile(file, input);
                    }
                });

                // æ‹–æ‹½äº‹ä»¶
                label.addEventListener('dragover', function(e) {
                    e.preventDefault();
                    label.classList.add('dragover');
                });

                label.addEventListener('dragleave', function(e) {
                    e.preventDefault();
                    label.classList.remove('dragover');
                });

                label.addEventListener('drop', function(e) {
                    e.preventDefault();
                    label.classList.remove('dragover');

                    const files = e.dataTransfer.files;
                    if (files.length > 0) {
                        input.files = files;
                        updateFileLabel(label, files[0]);
                        validateFile(files[0], input);
                    }
                });
            });
        }

        // æ›´æ–°æ–‡ä»¶æ ‡ç­¾
        function updateFileLabel(label, file) {
            const span = label.querySelector('span');
            const small = label.querySelector('small');

            span.textContent = file.name;
            small.textContent = `æ–‡ä»¶å¤§å°: ${formatFileSize(file.size)}`;
            label.classList.add('file-selected');
        }

        // éªŒè¯æ–‡ä»¶
        function validateFile(file, input) {
            const maxSize = 50 * 1024 * 1024; // 50MB
            const fileName = file.name.toLowerCase();
            
            // æ ¹æ®ä¸åŒçš„inputç¡®å®šå…è®¸çš„æ–‡ä»¶ç±»å‹
            let allowedTypes;
            if (input.id === 'import_national_file') {
                allowedTypes = ['.csv'];
            } else {
                allowedTypes = ['.xlsx', '.xls'];
            }

            // æ£€æŸ¥æ–‡ä»¶ç±»å‹
            const isValidType = allowedTypes.some(type => fileName.endsWith(type));

            if (!isValidType) {
                const typeStr = allowedTypes.join(' æˆ– ');
                showMessage(`æ–‡ä»¶ç±»å‹ä¸æ”¯æŒï¼Œè¯·é€‰æ‹© ${typeStr} æ ¼å¼çš„æ–‡ä»¶`, 'error');
                input.value = '';
                resetFileLabel(input.nextElementSibling);
                return false;
            }

            // æ£€æŸ¥æ–‡ä»¶å¤§å°
            if (file.size > maxSize) {
                showMessage('æ–‡ä»¶å¤§å°è¶…è¿‡50MBé™åˆ¶', 'error');
                input.value = '';
                resetFileLabel(input.nextElementSibling);
                return false;
            }

            return true;
        }

        // é‡ç½®æ–‡ä»¶æ ‡ç­¾
        function resetFileLabel(label) {
            const span = label.querySelector('span');
            const small = label.querySelector('small');
            const input = label.previousElementSibling;
            
            if (input.id === 'import_national_file') {
                span.textContent = 'é€‰æ‹©CSVæ–‡ä»¶æˆ–æ‹–æ‹½åˆ°æ­¤å¤„';
                small.textContent = 'æ”¯æŒ .csv æ ¼å¼ï¼Œæœ€å¤§50MB';
            } else {
                span.textContent = 'é€‰æ‹©Excelæ–‡ä»¶æˆ–æ‹–æ‹½åˆ°æ­¤å¤„';
                small.textContent = 'æ”¯æŒ .xlsx å’Œ .xls æ ¼å¼ï¼Œæœ€å¤§50MB';
            }
            label.classList.remove('file-selected');
        }

        // æ ¼å¼åŒ–æ–‡ä»¶å¤§å°
        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
        function showLoading(text = 'æ­£åœ¨å¤„ç†ä¸­...') {
            const overlay = document.getElementById('loadingOverlay');
            const loadingText = document.getElementById('loadingText');
            loadingText.textContent = text;
            overlay.style.display = 'flex';

            // ä¸ºå¯¼å…¥æ“ä½œæ·»åŠ è¶…æ—¶ä¿æŠ¤
            if (text.includes('å¯¼å…¥')) {
                setTimeout(() => {
                    if (overlay.style.display === 'flex') {
                        loadingText.textContent = text + ' (æ“ä½œæ—¶é—´è¾ƒé•¿ï¼Œè¯·è€å¿ƒç­‰å¾…...)';
                    }
                }, 10000); // 10ç§’åæ˜¾ç¤ºæç¤º

                setTimeout(() => {
                    if (overlay.style.display === 'flex') {
                        loadingText.textContent = text + ' (å¤§æ–‡ä»¶å¤„ç†ä¸­ï¼Œè¯·ç»§ç»­ç­‰å¾…...)';
                    }
                }, 30000); // 30ç§’åæ˜¾ç¤ºæç¤º
            }
        }

        // æ˜¾ç¤ºå¸¦è¿›åº¦åé¦ˆçš„åŠ è½½çŠ¶æ€ï¼ˆç”¨äºå¤§æ–‡ä»¶å¤„ç†ï¼‰
        function showLoadingWithProgress(text = 'æ­£åœ¨å¤„ç†ä¸­...') {
            const overlay = document.getElementById('loadingOverlay');
            const loadingText = document.getElementById('loadingText');
            
            // ä¿®æ”¹åŠ è½½æ–‡æœ¬æ˜¾ç¤ºï¼Œæ·»åŠ è¿›åº¦æç¤º
            loadingText.innerHTML = `
                <div style="text-align: center;">
                    <div style="margin-bottom: 10px;">${text}</div>
                    <div id="progressInfo" style="font-size: 14px; color: #666; margin-top: 10px;">
                        <div>â±ï¸ å¤„ç†å¤§é‡æ•°æ®éœ€è¦æ—¶é—´ï¼Œè¯·è€å¿ƒç­‰å¾…</div>
                        <div style="margin-top: 5px;">ğŸ”„ ç³»ç»Ÿæ­£åœ¨åå°å¤„ç†ï¼Œä¸ä¼šä¸¢å¤±æ‚¨çš„æ“ä½œ</div>
                    </div>
                </div>
            `;
            
            overlay.style.display = 'flex';
        }

        // æ›´æ–°åŠ è½½æ–‡æœ¬
        function updateLoadingText(newText) {
            const loadingText = document.getElementById('loadingText');
            if (loadingText && loadingText.parentElement.style.display === 'flex') {
                // æ£€æŸ¥æ˜¯å¦æ˜¯HTMLæ ¼å¼ï¼ˆå«æœ‰divï¼‰
                if (loadingText.innerHTML.includes('<div')) {
                    // æ›´æ–°ä¸»è¦æ–‡æœ¬ï¼Œä¿æŒè¿›åº¦ä¿¡æ¯
                    const progressInfo = document.getElementById('progressInfo');
                    if (progressInfo) {
                        loadingText.innerHTML = `
                            <div style="text-align: center;">
                                <div style="margin-bottom: 10px;">${newText}</div>
                                <div id="progressInfo" style="font-size: 14px; color: #666; margin-top: 10px;">
                                    <div>â±ï¸ æ­£åœ¨æ‰§è¡Œæ•°æ®åº“æ“ä½œï¼Œè¯·ç»§ç»­ç­‰å¾…</div>
                                    <div style="margin-top: 5px;">ğŸ” å¤§æ•°æ®é‡å¤„ç†éœ€è¦æ›´å¤šæ—¶é—´</div>
                                </div>
                            </div>
                        `;
                    } else {
                        loadingText.textContent = newText;
                    }
                } else {
                    loadingText.textContent = newText;
                }
            }
        }

        // éšè—åŠ è½½çŠ¶æ€
        function hideLoading() {
            const overlay = document.getElementById('loadingOverlay');
            overlay.style.display = 'none';
        }

        // æ˜¾ç¤ºæ¶ˆæ¯
        function showMessage(message, type = 'info') {
            const container = document.getElementById('messageContainer');
            const messageDiv = document.createElement('div');
            messageDiv.className = `message message-${type}`;

            const icon = type === 'success' ? 'check-circle' :
                        type === 'error' ? 'exclamation-circle' : 
                        type === 'warning' ? 'exclamation-triangle' : 'info-circle';

            messageDiv.innerHTML = `
                <i class="fas fa-${icon}"></i>
                <span>${message}</span>
                <button class="message-close" onclick="this.parentElement.remove()">
                    <i class="fas fa-times"></i>
                </button>
            `;

            container.appendChild(messageDiv);

            // æ ¹æ®æ¶ˆæ¯ç±»å‹è°ƒæ•´è‡ªåŠ¨ç§»é™¤æ—¶é—´
            const autoRemoveTime = type === 'warning' ? 15000 : 
                                  type === 'error' ? 12000 : 10000;

            // è‡ªåŠ¨ç§»é™¤æ¶ˆæ¯
            setTimeout(() => {
                if (messageDiv.parentElement) {
                    messageDiv.remove();
                }
            }, autoRemoveTime);
        }

        // æ˜¾ç¤ºç¡®è®¤å¯¹è¯æ¡†
        function showConfirmDialog(message, onConfirm) {
            const modal = document.getElementById('confirmModal');
            const messageEl = document.getElementById('confirmMessage');
            const yesBtn = document.getElementById('confirmYes');
            const noBtn = document.getElementById('confirmNo');

            messageEl.textContent = message;
            modal.style.display = 'flex';

            // ç§»é™¤ä¹‹å‰çš„äº‹ä»¶ç›‘å¬å™¨
            const newYesBtn = yesBtn.cloneNode(true);
            const newNoBtn = noBtn.cloneNode(true);
            yesBtn.parentNode.replaceChild(newYesBtn, yesBtn);
            noBtn.parentNode.replaceChild(newNoBtn, noBtn);

            // æ·»åŠ æ–°çš„äº‹ä»¶ç›‘å¬å™¨
            newYesBtn.addEventListener('click', () => {
                modal.style.display = 'none';
                onConfirm();
            });

            newNoBtn.addEventListener('click', () => {
                modal.style.display = 'none';
            });

            // ç‚¹å‡»èƒŒæ™¯å…³é—­
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    modal.style.display = 'none';
                }
            });
        }











    </script>
</body>
</html>