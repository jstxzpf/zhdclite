<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>住户数据整理系统</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/styles.css') }}">
    <!-- 添加Font Awesome图标库 -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 64 64'%3E%3Crect width='64' height='64' fill='%23007bff'/%3E%3Ctext x='50%' y='58%' dominant-baseline='middle' text-anchor='middle' font-size='42' fill='white'%3ES%3C/text%3E%3C/svg%3E">
</head>
<body>
    <!-- 加载遮罩 -->
    <div id="loadingOverlay" class="loading-overlay">
        <div class="loading-spinner">
            <i class="fas fa-spinner fa-spin"></i>
            <p id="loadingText">正在处理中...</p>
        </div>
    </div>

    <!-- 消息提示 -->
    <div id="messageContainer" class="message-container"></div>

    <!-- 主容器 -->
    <div class="container">
        <header class="header">
            <div class="header-content">
                <h1><i class="fas fa-home"></i> 住户数据整理系统</h1>
                <p class="subtitle">高效、安全的住户调查数据管理平台</p>
            </div>
            <!-- 系统状态指示器 -->
            <div class="system-status">
                <div class="status-item">
                    <i class="fas fa-database"></i>
                    <span>数据库连接</span>
                    <div class="status-indicator" id="dbStatus"></div>
                </div>
                <div class="status-item">
                    <i class="fas fa-clock"></i>
                    <span>系统时间</span>
                    <div class="status-time" id="systemTime"></div>
                </div>
            </div>
        </header>

        <!-- 导航菜单 -->
        <nav class="main-nav">
            <div class="nav-item active" data-section="data-generation">
                <i class="fas fa-chart-line"></i>
                <span>数据生成</span>
            </div>
            <div class="nav-item" data-section="data-import">
                <i class="fas fa-upload"></i>
                <span>数据导入</span>
            </div>


            <div class="nav-item" data-section="statistics">
                <i class="fas fa-chart-bar"></i>
                <span>数据统计</span>
            </div>
            <div class="nav-item" data-section="system-settings">
                <i class="fas fa-cog"></i>
                <span>系统设置</span>
            </div>


        </nav>

        <!-- 数据生成模块 -->
        <section class="module-section active" id="data-generation">
            <div class="section-header">
                <h2><i class="fas fa-chart-line"></i> 数据生成</h2>
                <p class="section-description">生成各类数据报表和台账文件</p>
            </div>



            <div class="form-card">
                <div class="card-header">
                    <h3><i class="fas fa-table"></i> 生成电子台账</h3>
                    <div class="card-status">
                        <span class="status-badge ready">就绪</span>
                    </div>
                </div>
                <form id="ledgerForm" action="/generate_electronic_ledger" method="post" target="_blank">
                    <div class="form-row">
                        <div class="form-group">
                            <label for="ledger_year">年度：</label>
                            <select name="year" id="ledger_year" required>
                                <option value="2023">2023</option>
                                <option value="2024">2024</option>
                                <option value="2025">2025</option>
                                <option value="2026">2026</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="ledger_month">月份：</label>
                            <select name="month" id="ledger_month" required>
                                <option value="01">01月</option>
                                <option value="02">02月</option>
                                <option value="03">03月</option>
                                <option value="04">04月</option>
                                <option value="05">05月</option>
                                <option value="06">06月</option>
                                <option value="07">07月</option>
                                <option value="08">08月</option>
                                <option value="09">09月</option>
                                <option value="10">10月</option>
                                <option value="11">11月</option>
                                <option value="12">12月</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="town">乡镇：</label>
                            <select name="town" id="town" required>
                                <option value="全部乡镇">全部乡镇</option>
                            </select>
                        </div>
                    </div>
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-download"></i> 生成电子台账
                    </button>
                </form>
            </div>

            <div class="form-card">
                <div class="card-header">
                    <h3><i class="fas fa-table"></i> 生成汇总表</h3>
                    <div class="card-status">
                        <span class="status-badge ready">就绪</span>
                    </div>
                </div>
                <form id="summaryForm" action="{{ url_for('data_generation.generate_summary_table') }}" method="post" target="_blank">
                    <div class="form-row">
                        <div class="form-group">
                            <label for="summary_year">年份：</label>
                            <select name="year" id="summary_year" required>
                                <option value="2023">2023</option>
                                <option value="2024" selected>2024</option>
                                <option value="2025">2025</option>
                                <option value="2026">2026</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="summary_period">期别：</label>
                            <select name="period" id="summary_period" required>
                                <option value="一季度">一季度</option>
                                <option value="上半年">上半年</option>
                                <option value="三季度">三季度</option>
                                <option value="全年度">全年度</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="summary_category">类别：</label>
                            <select name="category" id="summary_category" required>
                                <option value="全部">全部</option>
                                <option value="城镇点">城镇点</option>
                                <option value="农村点">农村点</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="summary_sample_point_type">样本点类型：</label>
                            <select name="sample_point_type" id="summary_sample_point_type" required>
                                <option value="全部类型" selected>全部类型</option>
                                <option value="国家点">国家点</option>
                            </select>
                        </div>
                    </div>
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-download"></i> 生成汇总表
                    </button>
                </form>
            </div>
        </section>

        <!-- 数据导入模块 -->
        <section class="module-section" id="data-import">
            <div class="section-header">
                <h2><i class="fas fa-upload"></i> 数据导入</h2>
                <p class="section-description">导入各类Excel数据文件到系统数据库</p>
            </div>



            <div class="form-card">
                <div class="card-header">
                    <h3><i class="fas fa-users"></i> 调查点户名单管理</h3>
                    <div class="card-status">
                        <span class="status-badge ready">就绪</span>
                    </div>
                </div>
                <div class="card-content">
                    <div class="button-group">
                        <button type="button" class="btn btn-primary" onclick="exportHouseholdList()">
                            <i class="fas fa-download"></i> 导出户名单
                        </button>
                        <button type="button" class="btn btn-info" onclick="document.getElementById('import_household_file').click()">
                            <i class="fas fa-upload"></i> 选择Excel文件导入
                        </button>
                    </div>
                    <form id="householdForm" action="/import_household_list" method="post" enctype="multipart/form-data" style="display: none;">
                        <input type="file" name="file" id="import_household_file" accept=".xlsx,.xls" onchange="importHouseholdList()">
                    </form>
                    <div class="form-help">
                        <p><i class="fas fa-info-circle"></i> 功能说明：</p>
                        <ul>
                            <li>导出：将当前数据库中的调查点户名单导出为Excel文件</li>
                            <li>导入：上传Excel文件更新调查点户名单数据</li>
                            <li>支持新增和更新操作，根据户代码自动判断</li>
                            <li>必需字段：户代码、户主姓名</li>
                        </ul>
                    </div>
                </div>
            </div>


            <div class="form-card">
                <div class="card-header">
                    <h3><i class="fas fa-map-marked-alt"></i> 调查点村名单管理</h3>
                    <div class="card-status">
                        <span class="status-badge ready">就绪</span>
                    </div>
                </div>
                <div class="card-content">
                    <div class="button-group">
                        <button type="button" class="btn btn-primary" onclick="exportVillageList()">
                            <i class="fas fa-download"></i> 导出村名单
                        </button>
                        <button type="button" class="btn btn-info" onclick="document.getElementById('import_village_file').click()">
                            <i class="fas fa-upload"></i> 选择Excel文件导入
                        </button>
                    </div>
                    <form id="villageForm" action="/import_village_list" method="post" enctype="multipart/form-data" style="display: none;">
                        <input type="file" name="file" id="import_village_file" accept=".xlsx,.xls" onchange="importVillageList()">
                    </form>
                    <div class="form-help">
                        <p><i class="fas fa-info-circle"></i> 功能说明：</p>
                        <ul>
                            <li>导出：将当前数据库中的调查点村名单导出为Excel文件</li>
                            <li>导入：上传Excel文件更新调查点村名单数据</li>
                            <li>支持新增和更新操作，根据“户代码前12位”自动判断</li>
                            <li>必需字段：户代码前12位、所在乡镇街道、村居名称</li>
                            <li>可选字段：数量、调查点类型、调查员姓名、调查员电话、城乡属性</li>
                        </ul>
                    </div>
                </div>
            </div>

            <div class="form-card">
                <div class="card-header">
                    <h3><i class="fas fa-flag"></i> 导入国家点数据</h3>
                    <div class="card-status">
                        <span class="status-badge ready">就绪</span>
                    </div>
                </div>
                <form id="nationalForm" action="/import_national_data" method="post" enctype="multipart/form-data">
                    <div class="file-upload-area">
                        <input type="file" name="file" id="import_national_file" accept=".csv" required>
                        <label for="import_national_file" class="file-upload-label">
                            <i class="fas fa-cloud-upload-alt"></i>
                            <span>选择CSV文件或拖拽到此处</span>
                            <small>支持 .csv 格式，最大50MB</small>
                        </label>
                    </div>
                    <button type="submit" class="btn btn-success">
                        <i class="fas fa-upload"></i> 导入国家点数据

                    </button>
                </form>
            </div>
        </section>


            <!-- 系统设置模块 -->
            <section class="module-section" id="system-settings">
                <div class="section-header">
                    <h2><i class="fas fa-cog"></i> 系统设置</h2>
                    <p class="section-description">数据库维护与风险操作，请谨慎使用</p>
                </div>

                <div class="form-card">
                    <div class="card-header">
                        <h3><i class="fas fa-shield-alt"></i> 数据维护与备份</h3>
                        <div class="card-status">
                            <span class="status-badge ready">就绪</span>
                        </div>
                    </div>
                    <div class="card-content">
                        <div class="button-group">
                            <!-- 危险操作：清空数据 -->
                            <button type="button" class="btn btn-danger" onclick="clearHouseholdList()">
                                <i class="fas fa-trash"></i> 清空调查点户名单
                            </button>
                            <button type="button" class="btn btn-danger" onclick="clearVillageList()">
                                <i class="fas fa-trash"></i> 清空调查点村名单
                            </button>
                            <button type="button" class="btn btn-danger" onclick="clearAccountData()">
                                <i class="fas fa-trash"></i> 清空当前账目数据
                            </button>
                        </div>
                        <div class="button-group" style="margin-top:12px;">
                            <!-- 备份 / 恢复 / 压缩数据库 -->
                            <button type="button" class="btn btn-primary" onclick="backupDatabase()">
                                <i class="fas fa-download"></i> 备份数据库
                            </button>
                            <button type="button" class="btn btn-primary" onclick="openRestoreDialog()">
                                <i class="fas fa-upload"></i> 恢复数据库
                            </button>
                            <button type="button" class="btn btn-secondary" onclick="compactDatabase()">
                                <i class="fas fa-compress"></i> 压缩数据库
                            </button>
                            <input type="file" id="restore_db_file" accept=".db" style="display:none" onchange="handleRestoreFileChange()" />
                        </div>
                        <div class="form-help">
                            <p><i class="fas fa-info-circle"></i> 使用说明：</p>
                            <ul>
                                <li>清空操作不可恢复，请先进行数据库备份。</li>
                                <li>备份会生成文件名格式为 <code>database_backup_YYYYMMDD_HHMMSS.db</code> 的文件供下载。</li>
                                <li>恢复将用上传的数据库文件替换当前数据库，当前数据将丢失。</li>
                            </ul>
                        </div>
                    </div>
                </div>
            </section>






    </div>

    <!-- 确认对话框 -->
    <div id="confirmModal" class="modal" style="display: none;">
        <div class="modal-content">
            <h3><i class="fas fa-exclamation-triangle"></i> 确认操作</h3>
            <p id="confirmMessage">您确定要执行此操作吗？</p>
            <div class="modal-buttons">
                <button id="confirmYes" class="btn btn-primary">确认</button>
                <button id="confirmNo" class="btn btn-secondary">取消</button>
            </div>
        </div>
    </div>

    <script>
        // 添加全局错误处理
        window.addEventListener('error', function(e) {
            console.error('全局JavaScript错误:', e.error);
            console.error('错误位置:', e.filename, '行:', e.lineno, '列:', e.colno);
        });

        // 页面加载完成后初始化
        document.addEventListener('DOMContentLoaded', function() {
            console.log('DOM内容加载完成，开始初始化...');

            // 添加一个简单的测试来验证JavaScript是否工作
            try {
                // 测试基础DOM操作
                const testElement = document.querySelector('h1');
                if (testElement) {
                    console.log('✅ 基础DOM操作正常');
                } else {
                    console.warn('⚠️ 未找到测试元素');
                }
            } catch (error) {
                console.error('❌ 基础DOM操作失败:', error);
            }

            try {
                console.log('1. 初始化页面...');
                initializePage();
                // 动态加载乡镇列表（从 /api/towns 获取，基于“调查点村名单”）
                populateTowns();

                console.log('2. 设置表单处理器...');
                setupFormHandlers();

                console.log('3. 设置文件上传...');
                setupFileUpload();

                console.log('4. 设置导航...');
                setupNavigation();

                console.log('5. 更新系统状态...');
                updateSystemStatus();

                console.log('6. 启动系统时间更新...');
                startSystemTimeUpdate();



                console.log('页面初始化完成！');
            } catch (error) {
                console.error('页面初始化失败:', error);
                // 显示错误信息到页面上
                const errorDiv = document.createElement('div');
                errorDiv.style.cssText = 'position:fixed;top:10px;right:10px;background:red;color:white;padding:10px;z-index:9999;';
                errorDiv.textContent = '页面初始化失败: ' + error.message;
                document.body.appendChild(errorDiv);
            }
        });

        // 初始化页面
        function initializePage() {
            const currentYear = new Date().getFullYear();
            const currentMonth = (new Date().getMonth() + 1).toString().padStart(2, '0');

            // 设置默认年月
            const yearSelects = document.querySelectorAll('select[name="year"]');
            const monthSelects = document.querySelectorAll('select[name="month"]');

            yearSelects.forEach(select => {
                select.value = currentYear;
            });

            monthSelects.forEach(select => {
                select.value = currentMonth;
            });
        }
        // 从接口填充乡镇下拉框（全局定义，供初始化调用）
        async function populateTowns() {
            const townSelect = document.getElementById('town');
            if (!townSelect) return;
            // 保留“全部乡镇”选项
            const keepFirst = townSelect.querySelector('option[value="全部乡镇"]');
            townSelect.innerHTML = '';
            if (keepFirst) townSelect.appendChild(keepFirst);
            try {
                const resp = await fetch('/api/towns');
                const json = await resp.json();
                if (json && json.success && Array.isArray(json.data)) {
                    json.data.forEach(town => {
                        if (town && typeof town === 'string') {
                            const opt = document.createElement('option');
                            opt.value = town;
                            opt.textContent = town;
                            townSelect.appendChild(opt);
                        }
                    });
                }
            } catch (e) {
                console.error('加载乡镇列表失败:', e);
            }
        }


        // 设置导航功能（简化并修复切换问题）
        function setupNavigation() {
            const navItems = document.querySelectorAll('.nav-item');
            const sections = document.querySelectorAll('.module-section');

            function activateSection(targetId) {
                // 切换内容区
                sections.forEach(section => {
                    if (section.id === targetId) {
                        section.classList.add('active');
                    } else {
                        section.classList.remove('active');
                    }
                });
                // 切换导航高亮
                navItems.forEach(item => {
                    if (item.getAttribute('data-section') === targetId) {
                        item.classList.add('active');
                    } else {
                        item.classList.remove('active');
                    }
                });
                // 滚动到顶部，提升可见性
                window.scrollTo({ top: 0, behavior: 'smooth' });
            }

            navItems.forEach(item => {
                item.addEventListener('click', function(ev) {
                    ev.preventDefault();
                    const targetSection = this.getAttribute('data-section');
                    if (!targetSection) return;

                    // 统计页面单独新开窗口
                    if (targetSection === 'statistics') {
                        window.open('/statistics', '_blank');
                        return;
                    }

                    activateSection(targetSection);
                });
            });
        }

        // 更新系统状态
        function updateSystemStatus() {
            const dbStatus = document.getElementById('dbStatus');

            // 检查数据库连接状态
            fetch('/api/system/status')
                .then(response => response.json())
                .then(data => {
                    if (data.database_connected) {
                        dbStatus.className = 'status-indicator online';
                        dbStatus.title = '数据库连接正常';
                    } else {
                        dbStatus.className = 'status-indicator offline';
                        dbStatus.title = '数据库连接异常';
                    }
                })
                .catch(() => {
                    dbStatus.className = 'status-indicator offline';
                    dbStatus.title = '无法获取状态';
                });
        }

        // 开始系统时间更新
        function startSystemTimeUpdate() {
            function updateTime() {
                const now = new Date();
                const timeString = now.getFullYear() + '年' +
                                 String(now.getMonth() + 1).padStart(2, '0') + '月' +
                                 String(now.getDate()).padStart(2, '0') + '日 ' +
                                 String(now.getHours()).padStart(2, '0') + ':' +
                                 String(now.getMinutes()).padStart(2, '0') + ':' +
                                 String(now.getSeconds()).padStart(2, '0');
                document.getElementById('systemTime').textContent = timeString;
            }

            updateTime();
            setInterval(updateTime, 1000);
        }

        // 设置表单处理器
        function setupFormHandlers() {
            // 数据生成表单
            setupLedgerFormSubmit(); // 电子台账使用特殊处理
            setupFormSubmit('summaryForm', '正在生成汇总表...');

            // 数据导入表单
            setupFormSubmit('nationalForm', '正在导入国家点数据...', true);


        }

        // 设置表单提交处理
        function setupFormSubmit(formId, loadingText, needConfirm = false) {
            const form = document.getElementById(formId);
            if (!form) return;

            form.addEventListener('submit', function(e) {
                if (needConfirm) {
                    e.preventDefault();
                    showConfirmDialog(getConfirmMessage(formId), () => {
                        submitForm(form, loadingText);
                    });
                } else {
                    e.preventDefault();
                    submitForm(form, loadingText);
                }
            });
        }

        // 获取确认消息
        function getConfirmMessage(formId) {
            const form = document.getElementById(formId);
            let baseMessage = '';

            const messages = {
                'nationalForm': '确定要导入国家点数据吗？此操作将向数据库添加新记录。'
            };
            baseMessage = messages[formId] || '确定要执行此操作吗？';

            // 检查文件大小并添加警告
            if (form) {
                const fileInput = form.querySelector('input[type="file"]');
                if (fileInput && fileInput.files.length > 0) {
                    const file = fileInput.files[0];
                    const fileSizeMB = file.size / (1024 * 1024);
                    if (fileSizeMB > 10) {
                        baseMessage += `\n\n注意：您选择的文件较大（${fileSizeMB.toFixed(1)}MB），处理时间可能较长，请耐心等待。`;
                    }
                }
            }

            return baseMessage;
        }

        // 提交表单 - 优化版支持异步处理和进度反馈
        function submitForm(form, loadingText) {
            const formId = form.getAttribute('id');

            // 检查是否为大文件上传，启用特殊处理
            const fileInput = form.querySelector('input[type="file"]');
            const isLargeFileUpload = fileInput && fileInput.files[0] && fileInput.files[0].size > 10 * 1024 * 1024; // 10MB

            if (formId === 'nationalForm' || isLargeFileUpload) {
                submitFormWithProgress(form, loadingText);
            } else {
                submitFormNormal(form, loadingText);
            }
        }

        // 普通表单提交（保持原有逻辑）
        function submitFormNormal(form, loadingText) {
            showLoading(loadingText);

            const formData = new FormData(form);
            const action = form.getAttribute('action');
            const method = form.getAttribute('method') || 'POST';

            // 创建AbortController用于超时控制
            const controller = new AbortController();
            const timeoutId = setTimeout(() => {
                controller.abort();
            }, 300000); // 5分钟超时

            fetch(action, {
                method: method,
                body: formData,
                signal: controller.signal
            })
            .then(response => {
                // 检查内容类型
                const contentType = response.headers.get('content-type');

                if (contentType && contentType.includes('application/json')) {
                    // 处理JSON响应
                    return response.json().then(data => {
                        showMessage(data.message || '操作完成', data.success ? 'success' : 'error');
                    });
                } else if (contentType && contentType.includes('application/')) {
                    // 处理文件下载
                    if (response.ok) {
                        return response.blob().then(blob => {
                            const url = window.URL.createObjectURL(blob);
                            const a = document.createElement('a');
                            a.href = url;

                            // 尝试从响应头获取文件名
                            let filename = getFileNameFromResponse(response, action);
                            a.download = filename;

                            document.body.appendChild(a);
                            a.click();
                            window.URL.revokeObjectURL(url);
                            document.body.removeChild(a);
                            showMessage('文件生成成功！', 'success');
                        });
                    } else {
                        return response.text().then(text => {
                            showMessage(text || '文件生成失败', 'error');
                        });
                    }
                } else {
                    // 处理文本响应
                    return response.text().then(text => {
                        showMessage(text || (response.ok ? '操作成功' : '操作失败'), response.ok ? 'success' : 'error');
                    });
                }
            })
            .catch(error => {
                clearTimeout(timeoutId);
                if (error.name === 'AbortError') {
                    showMessage('操作超时，请检查文件大小或网络连接', 'error');
                } else {
                    showMessage('网络错误：' + error.message, 'error');
                }
            })
            .finally(() => {
                clearTimeout(timeoutId);
                hideLoading();
            });
        }

        // 带进度的异步表单提交（用于大文件处理）
        function submitFormWithProgress(form, loadingText) {
            const formId = form.getAttribute('id');
            const action = form.getAttribute('action');
            const formData = new FormData(form);

            // 显示带进度的加载状态
            showLoadingWithProgress(loadingText);

            // 启动进度监控
            let progressMonitor = null;
            let completedSuccessfully = false;

            // 提交表单
            fetch(action, {
                method: 'POST',
                body: formData
            })
            .then(async response => {
                const contentType = response.headers.get('content-type');

                if (contentType && contentType.includes('application/json')) {
                    const data = await response.json();
                    completedSuccessfully = data.success || response.ok;
                    showMessage(data.message || '操作完成', completedSuccessfully ? 'success' : 'error');
                } else {
                    const text = await response.text();
                    completedSuccessfully = response.ok;
                    showMessage(text || (response.ok ? '操作成功' : '操作失败'), response.ok ? 'success' : 'error');
                }
            })
            .catch(error => {
                completedSuccessfully = false;
                if (error.name === 'AbortError') {
                    showMessage('操作可能因文件过大而超时，但后台仍在处理中', 'warning');
                } else {
                    showMessage('网络错误：' + error.message, 'error');
                }
            })
            .finally(() => {
                if (progressMonitor) {
                    clearInterval(progressMonitor);
                }
                hideLoading();
            });

            // 如果是国家点导入，启动进度监控
            if (formId === 'nationalForm') {
                let progressStep = 0;
                const progressSteps = [
                    '正在读取CSV文件...',
                    '正在验证数据格式...',
                    '正在导入到临时表...',
                    '正在验证数据完整性...',
                    '正在合并到主表...',
                    '正在更新编码信息...',
                    '正在完成最后处理...'
                ];

                progressMonitor = setInterval(() => {
                    if (!completedSuccessfully && progressStep < progressSteps.length - 1) {
                        progressStep++;
                        updateLoadingText(progressSteps[progressStep]);
                    }
                }, 15000); // 每15秒更新一次进度提示
            }
        }

        // 电子台账表单特殊处理（支持进度反馈）
        function setupLedgerFormSubmit() {
            const form = document.getElementById('ledgerForm');
            if (!form) return;

            form.addEventListener('submit', function(e) {
                e.preventDefault();

                const formData = new FormData(form);
                const town = formData.get('town');

                // 生成任务ID
                const taskId = 'ledger_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
                formData.append('task_id', taskId);

                // 确定加载文本
                let loadingText;
                if (town === '全部乡镇') {
                    loadingText = '正在准备批量生成电子台账...';
                } else {
                    loadingText = `正在生成 ${town} 电子台账...`;
                }

                // 显示加载状态
                showLoadingWithProgress(loadingText);

                // 启动进度监控
                const progressMonitor = startLedgerProgressMonitor(taskId, town);

                // 提交表单
                fetch(form.action, {
                    method: 'POST',
                    body: formData
                })
                .then(response => {
                    if (response.ok) {
                        return response.blob().then(blob => {
                            const fileName = getFileNameFromResponse(response, form.action);
                            // 内联下载逻辑，避免依赖外部函数未定义
                            const url = window.URL.createObjectURL(blob);
                            const a = document.createElement('a');
                            a.style.display = 'none';
                            a.href = url;
                            a.download = fileName;
                            document.body.appendChild(a);
                            a.click();
                            window.URL.revokeObjectURL(url);
                            document.body.removeChild(a);
                            showMessage('电子台账生成成功！', 'success');
                        });
                    } else {
                        return response.text().then(text => {
                            throw new Error(text || '生成失败');
                        });
                    }
                })
                .catch(error => {
                    console.error('电子台账生成失败:', error);
                    showMessage('生成失败：' + error.message, 'error');
                })
                .finally(() => {
                    clearInterval(progressMonitor);
                    hideLoading();
                });
            });
        }

        // 启动电子台账进度监控
        function startLedgerProgressMonitor(taskId, town) {
            return setInterval(() => {
                fetch(`/ledger_progress/${taskId}`)
                .then(response => response.json())
                .then(data => {
                    if (data.success && data.progress) {
                        const progress = data.progress;
                        let progressText;

                        if (progress.status === 'processing') {
                            if (town === '全部乡镇') {
                                progressText = `正在生成 ${progress.current_town} 电子台账... (${progress.current_index}/${progress.total_towns})`;
                            } else {
                                progressText = `正在生成 ${progress.current_town} 电子台账...`;
                            }
                        } else if (progress.status === 'completed') {
                            if (town === '全部乡镇') {
                                progressText = `全部乡镇电子台账生成完成！正在打包下载...`;
                            } else {
                                progressText = `${progress.current_town} 电子台账生成完成！正在准备下载...`;
                            }
                        }

                        updateLoadingText(progressText);
                    }
                })
                .catch(error => {
                    console.warn('获取进度失败:', error);
                });
            }, 2000); // 每2秒检查一次进度
        }

        // 从响应头获取文件名
        function getFileNameFromResponse(response, action) {
            // 尝试从Content-Disposition头获取文件名
            const contentDisposition = response.headers.get('Content-Disposition');
            if (contentDisposition) {
                // 优先匹配 filename*=UTF-8''filename (RFC 5987标准，支持中文)
                const utf8Match = contentDisposition.match(/filename\*=UTF-8''([^;]+)/);
                if (utf8Match) {
                    try {
                        return decodeURIComponent(utf8Match[1]);
                    } catch (e) {
                        console.warn('UTF-8文件名解码失败:', e);
                    }
                }

                // 回退到 filename="filename" (ASCII安全)
                const asciiMatch = contentDisposition.match(/filename="([^"]+)"/);
                if (asciiMatch) {
                    return asciiMatch[1];
                }
            }

            // 回退到默认文件名
            return getDefaultFileName(action);
        }

        // 获取默认文件名
        function getDefaultFileName(action) {
            if (action && action.includes('ledger')) return '电子台账.xlsx';
            return 'download.xlsx';
        }

        // 下载Blob文件的通用方法
        function downloadBlob(blob, fileName) {
            try {
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.style.display = 'none';
                a.href = url;
                a.download = fileName || 'download.xlsx';
                document.body.appendChild(a);
                a.click();
                window.URL.revokeObjectURL(url);
                document.body.removeChild(a);
            } catch (e) {
                console.error('下载文件失败:', e);
                showMessage('文件下载失败：' + (e && e.message ? e.message : e), 'error');
            }
        }

        // 获取与 input 关联的 label（优先 for=，回退 nextElementSibling）
        function getAssociatedLabel(input) {
            if (!input) return null;
            if (input.id) {
                const byFor = document.querySelector(`label[for="${CSS.escape(input.id)}"]`);
                if (byFor) return byFor;
            }
            const sib = input.nextElementSibling;
            if (sib && sib.tagName && sib.tagName.toLowerCase() === 'label') return sib;
            return null;
        }



        // 设置文件上传
        function setupFileUpload() {
            const fileInputs = document.querySelectorAll('input[type="file"]');

            fileInputs.forEach(input => {
                const label = getAssociatedLabel(input);

                // 文件选择事件（始终绑定）
                input.addEventListener('change', function(e) {
                    const file = e.target.files[0];
                    if (file) {
                        // 仅当存在关联的label时才更新展示
                        if (label && label.tagName && label.tagName.toLowerCase() === 'label') {
                            updateFileLabel(label, file);
                        }
                        validateFile(file, input);
                    }
                });

                // 如果没有配套的label（如隐藏的原生input），跳过拖拽相关事件
                if (!(label && label.tagName && label.tagName.toLowerCase() === 'label')) {
                    return;
                }

                // 拖拽事件
                label.addEventListener('dragover', function(e) {
                    e.preventDefault();
                    label.classList.add('dragover');
                });

                label.addEventListener('dragleave', function(e) {
                    e.preventDefault();
                    label.classList.remove('dragover');
                });

                label.addEventListener('drop', function(e) {
                    e.preventDefault();
                    label.classList.remove('dragover');

                    const files = e.dataTransfer.files;
                    if (files.length > 0) {
                        input.files = files;
                        updateFileLabel(label, files[0]);
                        validateFile(files[0], input);
                    }
                });
            });
        }

        // 更新文件标签（对缺少自定义label的input安全降级）
        function updateFileLabel(label, file) {
            if (!label || !label.querySelector) return;
            const span = label.querySelector('span');
            const small = label.querySelector('small');

            if (span) span.textContent = file.name;
            if (small) small.textContent = `文件大小: ${formatFileSize(file.size)}`;
            if (label.classList) label.classList.add('file-selected');
        }

        // 验证文件
        function validateFile(file, input) {
            const maxSize = 50 * 1024 * 1024; // 50MB
            const fileName = file.name.toLowerCase();

            // 根据不同的input确定允许的文件类型
            let allowedTypes;
            if (input.id === 'import_national_file') {
                allowedTypes = ['.csv'];
            } else {
                allowedTypes = ['.xlsx', '.xls'];
            }

            // 检查文件类型
            const isValidType = allowedTypes.some(type => fileName.endsWith(type));

            if (!isValidType) {
                const typeStr = allowedTypes.join(' 或 ');
                showMessage(`文件类型不支持，请选择 ${typeStr} 格式的文件`, 'error');
                input.value = '';
                const siblingLabel = getAssociatedLabel(input);
                if (siblingLabel) {
                    resetFileLabel(siblingLabel);
                }
                return false;
            }

            // 检查文件大小
            if (file.size > maxSize) {
                showMessage('文件大小超过50MB限制', 'error');
                input.value = '';
                const siblingLabel = getAssociatedLabel(input);
                if (siblingLabel) {
                    resetFileLabel(siblingLabel);
                }
                return false;
            }

            return true;
        }

        // 重置文件标签
        function resetFileLabel(label) {
            const span = label.querySelector('span');
            const small = label.querySelector('small');
            const input = label.previousElementSibling;

            if (input.id === 'import_national_file') {
                span.textContent = '选择CSV文件或拖拽到此处';
                small.textContent = '支持 .csv 格式，最大50MB';
            } else {
                span.textContent = '选择Excel文件或拖拽到此处';
                small.textContent = '支持 .xlsx 和 .xls 格式，最大50MB';
            }
            label.classList.remove('file-selected');
        }

        // 格式化文件大小
        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        // 显示加载状态
        function showLoading(text = '正在处理中...') {
            const overlay = document.getElementById('loadingOverlay');
            const loadingText = document.getElementById('loadingText');
            loadingText.textContent = text;
            overlay.style.display = 'flex';

            // 为导入操作添加超时保护
            if (text.includes('导入')) {
                setTimeout(() => {
                    if (overlay.style.display === 'flex') {
                        loadingText.textContent = text + ' (操作时间较长，请耐心等待...)';
                    }
                }, 10000); // 10秒后显示提示

                setTimeout(() => {
                    if (overlay.style.display === 'flex') {
                        loadingText.textContent = text + ' (大文件处理中，请继续等待...)';
                    }
                }, 30000); // 30秒后显示提示
            }
        }

        // 显示带进度反馈的加载状态（用于大文件处理）
        function showLoadingWithProgress(text = '正在处理中...') {
            const overlay = document.getElementById('loadingOverlay');
            const loadingText = document.getElementById('loadingText');

            // 修改加载文本显示，添加进度提示
            loadingText.innerHTML = `
                <div style="text-align: center;">
                    <div style="margin-bottom: 10px;">${text}</div>
                    <div id="progressInfo" style="font-size: 14px; color: #666; margin-top: 10px;">
                        <div>⏱️ 处理大量数据需要时间，请耐心等待</div>
                        <div style="margin-top: 5px;">🔄 系统正在后台处理，不会丢失您的操作</div>
                    </div>
                </div>
            `;

            overlay.style.display = 'flex';
        }

        // 更新加载文本
        function updateLoadingText(newText) {
            const loadingText = document.getElementById('loadingText');
            if (loadingText && loadingText.parentElement.style.display === 'flex') {
                // 检查是否是HTML格式（含有div）
                if (loadingText.innerHTML.includes('<div')) {
                    // 更新主要文本，保持进度信息
                    const progressInfo = document.getElementById('progressInfo');
                    if (progressInfo) {
                        loadingText.innerHTML = `
                            <div style="text-align: center;">
                                <div style="margin-bottom: 10px;">${newText}</div>
                                <div id="progressInfo" style="font-size: 14px; color: #666; margin-top: 10px;">
                                    <div>⏱️ 正在执行数据库操作，请继续等待</div>
                                    <div style="margin-top: 5px;">🔍 大数据量处理需要更多时间</div>
                                </div>
                            </div>
                        `;
                    } else {
                        loadingText.textContent = newText;
                    }
                } else {
                    loadingText.textContent = newText;
                }
            }
        }

        // 隐藏加载状态
        function hideLoading() {
            const overlay = document.getElementById('loadingOverlay');
            overlay.style.display = 'none';
        }

        // 显示消息
        function showMessage(message, type = 'info') {
            const container = document.getElementById('messageContainer');
            const messageDiv = document.createElement('div');
            messageDiv.className = `message message-${type}`;

            const icon = type === 'success' ? 'check-circle' :
                        type === 'error' ? 'exclamation-circle' :
                        type === 'warning' ? 'exclamation-triangle' : 'info-circle';

            messageDiv.innerHTML = `
                <i class="fas fa-${icon}"></i>
                <span>${message}</span>
                <button class="message-close" onclick="this.parentElement.remove()">
                    <i class="fas fa-times"></i>
                </button>
            `;

            container.appendChild(messageDiv);

            // 根据消息类型调整自动移除时间
            const autoRemoveTime = type === 'warning' ? 15000 :
                                  type === 'error' ? 12000 : 10000;

            // 自动移除消息
            setTimeout(() => {
                if (messageDiv.parentElement) {
                    messageDiv.remove();
                }
            }, autoRemoveTime);
        }

        // 显示确认对话框
        function showConfirmDialog(message, onConfirm) {
            const modal = document.getElementById('confirmModal');
            const messageEl = document.getElementById('confirmMessage');
            const yesBtn = document.getElementById('confirmYes');
            const noBtn = document.getElementById('confirmNo');

            messageEl.textContent = message;
            modal.style.display = 'flex';

            // 移除之前的事件监听器
            const newYesBtn = yesBtn.cloneNode(true);
            const newNoBtn = noBtn.cloneNode(true);
            yesBtn.parentNode.replaceChild(newYesBtn, yesBtn);
            noBtn.parentNode.replaceChild(newNoBtn, noBtn);

            // 添加新的事件监听器
            newYesBtn.addEventListener('click', () => {
                modal.style.display = 'none';
                onConfirm();
            });

            newNoBtn.addEventListener('click', () => {
                modal.style.display = 'none';
            });

            // 点击背景关闭
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    modal.style.display = 'none';
                }
            });
        }
        // 调查点户名单导出功能
        function exportHouseholdList() {
            showLoading('正在导出调查点户名单...');

            fetch('/export_household_list', {
                method: 'GET'
            })
            .then(response => {
                if (response.ok) {
                    // 获取文件名
                    const contentDisposition = response.headers.get('Content-Disposition');
                    let filename = '调查点户名单.xlsx';
                    if (contentDisposition) {
                        const filenameMatch = contentDisposition.match(/filename[^;=\n]*=((['"]).*?\2|[^;\n]*)/);
                        if (filenameMatch && filenameMatch[1]) {
                            filename = filenameMatch[1].replace(/['"]/g, '');
                        }
                    }

                    // 下载文件
                    return response.blob().then(blob => {
                        const url = window.URL.createObjectURL(blob);
                        const a = document.createElement('a');
                        a.style.display = 'none';
                        a.href = url;
                        a.download = filename;
                        document.body.appendChild(a);
                        a.click();
                        window.URL.revokeObjectURL(url);
                        document.body.removeChild(a);

                        hideLoading();
                        showMessage('调查点户名单导出成功！', 'success');
                    });
                } else {
                    return response.json().then(data => {
                        throw new Error(data.message || '导出失败');
                    });
                }
            })
            .catch(error => {
                hideLoading();
                console.error('导出调查点户名单失败:', error);
                showMessage(`导出失败: ${error.message}`, 'error');
            });
        }

            // 调查点村名单导出功能
            function exportVillageList() {
                showLoading('正在导出调查点村名单...');
                fetch('/export_village_list', { method: 'GET' })
                    .then(response => {
                        if (response.ok) {
                            const contentDisposition = response.headers.get('Content-Disposition');
                            let filename = '调查点村名单.xlsx';
                            if (contentDisposition) {
                                const match = contentDisposition.match(/filename[^;=\n]*=((['"]).*?\2|[^;\n]*)/);
                                if (match && match[1]) filename = match[1].replace(/['"]/g, '');
                            }
                            return response.blob().then(blob => {
                                const url = window.URL.createObjectURL(blob);
                                const a = document.createElement('a');
                                a.style.display = 'none';
                                a.href = url;
                                a.download = filename;
                                document.body.appendChild(a);
                                a.click();
                                window.URL.revokeObjectURL(url);
                                document.body.removeChild(a);
                                hideLoading();
                                showMessage('调查点村名单导出成功！', 'success');
                            });
                        } else {
                            return response.json().then(data => { throw new Error(data.message || '导出失败'); });
                        }
                    })
                    .catch(error => {
                        hideLoading();
                        console.error('导出调查点村名单失败:', error);
                        showMessage(`导出失败: ${error.message}`, 'error');
                    });
            }

            // 调查点村名单导入功能
            function importVillageList() {
                const fileInput = document.getElementById('import_village_file');
                const file = fileInput.files[0];
                if (!file) {
                    showMessage('请选择要导入的Excel文件', 'warning');
                    return;
                }
                const allowedTypes = [
                    'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet',
                    'application/vnd.ms-excel'
                ];
                if (!allowedTypes.includes(file.type) && !file.name.match(/\.(xlsx|xls)$/i)) {
                    showMessage('请选择Excel文件（.xlsx或.xls格式）', 'error');
                    fileInput.value = '';
                    return;
                }
                const maxSize = 50 * 1024 * 1024; // 50MB
                if (file.size > maxSize) {
                    showMessage('文件大小不能超过50MB', 'error');
                    fileInput.value = '';
                    return;
                }
                // 确认导入并提交表单
                const confirmMessage = `确定要导入调查点村名单吗？\n\n文件名: ${file.name}\n文件大小: ${(file.size / 1024 / 1024).toFixed(2)}MB\n\n此操作将更新数据库中的村名单数据。`;
                showConfirmDialog(confirmMessage, () => {
                    const form = document.getElementById('villageForm');
                    submitFormWithProgress(form, '正在导入调查点村名单...');
                });
            }


            // ===== 系统设置 前端交互 =====
            function clearWithConfirm(url, confirmText, loadingText) {
                showConfirmDialog(confirmText, () => {
                    showLoading(loadingText);
                    fetch(url, { method: 'DELETE' })
                        .then(res => res.json())
                        .then(data => {
                            showMessage(data.message || '操作完成', data.success ? 'success' : 'error');
                        })
                        .catch(err => {
                            showMessage('请求失败：' + err.message, 'error');
                        })
                        .finally(() => hideLoading());
                });
            }

            function clearHouseholdList() {
                clearWithConfirm(
                    '/api/system/clear-household-list',
                    '此操作将永久删除所有调查点户名单数据，无法恢复。确定要继续吗？',
                    '正在清空调查点户名单...'
                );
            }

            function clearVillageList() {
                clearWithConfirm(
                    '/api/system/clear-village-list',
                    '此操作将永久删除所有调查点村名单数据，无法恢复。确定要继续吗？',
                    '正在清空调查点村名单...'
                );
            }

            function clearAccountData() {
                clearWithConfirm(
                    '/api/system/clear-account-data',
                    '此操作将永久删除所有当前账目数据，无法恢复。确定要继续吗？',
                    '正在清空当前账目数据...'
                );
            }

            function backupDatabase() {
                showLoading('正在创建数据库备份...');
                fetch('/api/system/backup-database')
                    .then(response => {
                        if (!response.ok) throw new Error('备份失败');
                        const disposition = response.headers.get('Content-Disposition');
                        let filename = 'database_backup.db';
                        if (disposition) {
                            const match = disposition.match(/filename\*=UTF-8''([^;]+)|filename="([^"]+)"/);
                            if (match) filename = decodeURIComponent(match[1] || match[2]);
                        }
                        return response.blob().then(blob => ({ blob, filename }));
                    })
                    .then(({ blob, filename }) => {
                        const url = window.URL.createObjectURL(blob);
                        const a = document.createElement('a');
                        a.href = url;
                        a.download = filename;
                        document.body.appendChild(a);
                        a.click();
                        window.URL.revokeObjectURL(url);
                        document.body.removeChild(a);
                        showMessage('数据库备份成功', 'success');
                    })
                    .catch(err => {
                        showMessage('备份失败：' + err.message, 'error');
                    })
                    .finally(() => hideLoading());
            }

            function openRestoreDialog() {
                const input = document.getElementById('restore_db_file');
                if (input) input.click();
            }

            function handleRestoreFileChange() {
                const input = document.getElementById('restore_db_file');
                const file = input.files && input.files[0];
                if (!file) return;
                if (!file.name.toLowerCase().endsWith('.db')) {
                    showMessage('仅支持 .db SQLite 文件', 'error');
                    input.value = '';
                    return;
                }
                const confirmText = '此操作将用上传的数据库文件替换当前数据库，当前数据将丢失。确定要继续吗？';
                showConfirmDialog(confirmText, () => doRestore(file));
            }

            function doRestore(file) {
                const formData = new FormData();
                formData.append('file', file);
                showLoading('正在恢复数据库...');
                fetch('/api/system/restore-database', { method: 'POST', body: formData })
                    .then(res => res.json())
                    .then(data => {
                        showMessage(data.message || '恢复完成', data.success ? 'success' : 'error');
                    })
                    .catch(err => {
                        showMessage('恢复失败：' + err.message, 'error');
                    })
                    .finally(() => hideLoading());
            }

            // 压缩数据库（VACUUM）
            function compactDatabase() {
                const confirmText = '压缩数据库将执行 WAL checkpoint + VACUUM 操作，期间会短暂占用数据库资源。确定要继续吗？';
                showConfirmDialog(confirmText, () => {
                    showLoadingWithProgress('正在压缩数据库...');
                    const steps = ['正在执行 WAL checkpoint...', '正在执行 VACUUM 收缩...', '正在优化数据库...'];
                    let idx = 0;
                    const timer = setInterval(() => {
                        idx = (idx + 1) % steps.length;
                        updateLoadingText(steps[idx]);
                    }, 3000);

                    fetch('/api/system/compact-database', { method: 'POST' })
                        .then(res => res.json())
                        .then(data => {
                            showMessage(data.message || '压缩完成', data.success ? 'success' : 'error');
                        })
                        .catch(err => {
                            showMessage('压缩失败：' + err.message, 'error');
                        })
                        .finally(() => {
                            clearInterval(timer);
                            hideLoading();
                            updateSystemStatus();
                        });
                });
            }



        // 调查点户名单导入功能
        function importHouseholdList() {
            const fileInput = document.getElementById('import_household_file');
            const file = fileInput.files[0];

            if (!file) {
                showMessage('请选择要导入的Excel文件', 'warning');
                return;
            }

            // 验证文件类型
            const allowedTypes = [
                'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet',
                'application/vnd.ms-excel'
            ];

            if (!allowedTypes.includes(file.type) && !file.name.match(/\.(xlsx|xls)$/i)) {
                showMessage('请选择Excel文件（.xlsx或.xls格式）', 'error');
                fileInput.value = '';
                return;
            }

            // 验证文件大小
            const maxSize = 50 * 1024 * 1024; // 50MB
            if (file.size > maxSize) {
                showMessage('文件大小不能超过50MB', 'error');
                fileInput.value = '';
                return;
            }

            // 确认导入
            const confirmMessage = `确定要导入调查点户名单吗？\n\n文件名: ${file.name}\n文件大小: ${(file.size / 1024 / 1024).toFixed(2)}MB\n\n此操作将更新数据库中的户名单数据。`;

            showConfirmDialog(confirmMessage, () => {
                const form = document.getElementById('householdForm');
                submitFormWithProgress(form, '正在导入调查点户名单...');
            });
        }











    </script>
</body>
</html>