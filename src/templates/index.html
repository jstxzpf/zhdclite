<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>住户数据整理系统</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/styles.css') }}">
    <!-- 添加Font Awesome图标库 -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>
<body>
    <!-- 加载遮罩 -->
    <div id="loadingOverlay" class="loading-overlay">
        <div class="loading-spinner">
            <i class="fas fa-spinner fa-spin"></i>
            <p id="loadingText">正在处理中...</p>
        </div>
    </div>

    <!-- 消息提示 -->
    <div id="messageContainer" class="message-container"></div>

    <!-- 主容器 -->
    <div class="container">
        <header class="header">
            <div class="header-content">
                <h1><i class="fas fa-home"></i> 住户数据整理系统</h1>
                <p class="subtitle">高效、安全的住户调查数据管理平台</p>
            </div>
            <!-- 系统状态指示器 -->
            <div class="system-status">
                <div class="status-item">
                    <i class="fas fa-database"></i>
                    <span>数据库连接</span>
                    <div class="status-indicator" id="dbStatus"></div>
                </div>
                <div class="status-item">
                    <i class="fas fa-clock"></i>
                    <span>系统时间</span>
                    <div class="status-time" id="systemTime"></div>
                </div>
            </div>
        </header>

        <!-- 导航菜单 -->
        <nav class="main-nav">
            <div class="nav-item active" data-section="data-generation">
                <i class="fas fa-chart-line"></i>
                <span>数据生成</span>
            </div>
            <div class="nav-item" data-section="data-import">
                <i class="fas fa-upload"></i>
                <span>数据导入</span>
            </div>


            <div class="nav-item" data-section="statistics">
                <i class="fas fa-chart-bar"></i>
                <span>数据统计</span>
            </div>

        </nav>

        <!-- 数据生成模块 -->
        <section class="module-section active" id="data-generation">
            <div class="section-header">
                <h2><i class="fas fa-chart-line"></i> 数据生成</h2>
                <p class="section-description">生成各类数据报表和台账文件</p>
            </div>



            <div class="form-card">
                <div class="card-header">
                    <h3><i class="fas fa-table"></i> 生成电子台账</h3>
                    <div class="card-status">
                        <span class="status-badge ready">就绪</span>
                    </div>
                </div>
                <form id="ledgerForm" action="/generate_electronic_ledger" method="post" target="_blank">
                    <div class="form-row">
                        <div class="form-group">
                            <label for="ledger_year">年度：</label>
                            <select name="year" id="ledger_year" required>
                                <option value="2023">2023</option>
                                <option value="2024">2024</option>
                                <option value="2025">2025</option>
                                <option value="2026">2026</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="ledger_month">月份：</label>
                            <select name="month" id="ledger_month" required>
                                <option value="01">01月</option>
                                <option value="02">02月</option>
                                <option value="03">03月</option>
                                <option value="04">04月</option>
                                <option value="05">05月</option>
                                <option value="06">06月</option>
                                <option value="07">07月</option>
                                <option value="08">08月</option>
                                <option value="09">09月</option>
                                <option value="10">10月</option>
                                <option value="11">11月</option>
                                <option value="12">12月</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="town">乡镇：</label>
                            <select name="town" id="town" required>
                                <option value="全部乡镇">全部乡镇</option>
                                <option value="分界镇">分界镇</option>
                                <option value="滨江镇">滨江镇</option>
                                <option value="黄桥镇">黄桥镇</option>
                                <option value="延令济川街道">延令济川街道</option>
                                <option value="古溪镇">古溪镇</option>
                                <option value="元竹镇">元竹镇</option>
                                <option value="珊瑚镇">珊瑚镇</option>
                                <option value="曲霞镇">曲霞镇</option>
                                <option value="广陵镇">广陵镇</option>
                                <option value="张桥镇">张桥镇</option>
                                <option value="河失镇">河失镇</option>
                                <option value="新街镇">新街镇</option>
                                <option value="姚王街道">姚王街道</option>
                                <option value="宣堡镇">宣堡镇</option>
                                <option value="虹桥镇">虹桥镇</option>
                                <option value="根思乡">根思乡</option>
                            </select>
                        </div>
                    </div>
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-download"></i> 生成电子台账
                    </button>
                </form>
            </div>

            <div class="form-card">
                <div class="card-header">
                    <h3><i class="fas fa-table"></i> 生成汇总表</h3>
                    <div class="card-status">
                        <span class="status-badge ready">就绪</span>
                    </div>
                </div>
                <form id="summaryForm" action="{{ url_for('data_generation.generate_summary_table') }}" method="post" target="_blank">
                    <div class="form-row">
                        <div class="form-group">
                            <label for="summary_year">年份：</label>
                            <select name="year" id="summary_year" required>
                                <option value="2023">2023</option>
                                <option value="2024" selected>2024</option>
                                <option value="2025">2025</option>
                                <option value="2026">2026</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="summary_period">期别：</label>
                            <select name="period" id="summary_period" required>
                                <option value="一季度">一季度</option>
                                <option value="上半年">上半年</option>
                                <option value="三季度">三季度</option>
                                <option value="全年度">全年度</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="summary_category">类别：</label>
                            <select name="category" id="summary_category" required>
                                <option value="全部">全部</option>
                                <option value="城镇点">城镇点</option>
                                <option value="农村点">农村点</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="summary_sample_point_type">样本点类型：</label>
                            <select name="sample_point_type" id="summary_sample_point_type" required>
                                <option value="全部类型" selected>全部类型</option>
                                <option value="国家点">国家点</option>
                            </select>
                        </div>
                    </div>
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-download"></i> 生成汇总表
                    </button>
                </form>
            </div>
        </section>

        <!-- 数据导入模块 -->
        <section class="module-section" id="data-import">
            <div class="section-header">
                <h2><i class="fas fa-upload"></i> 数据导入</h2>
                <p class="section-description">导入各类Excel数据文件到系统数据库</p>
            </div>



            <div class="form-card">
                <div class="card-header">
                    <h3><i class="fas fa-flag"></i> 导入国家点数据</h3>
                    <div class="card-status">
                        <span class="status-badge ready">就绪</span>
                    </div>
                </div>
                <form id="nationalForm" action="/import_national_data" method="post" enctype="multipart/form-data">
                    <div class="file-upload-area">
                        <input type="file" name="file" id="import_national_file" accept=".csv" required>
                        <label for="import_national_file" class="file-upload-label">
                            <i class="fas fa-cloud-upload-alt"></i>
                            <span>选择CSV文件或拖拽到此处</span>
                            <small>支持 .csv 格式，最大50MB</small>
                        </label>
                    </div>
                    <button type="submit" class="btn btn-success">
                        <i class="fas fa-upload"></i> 导入国家点数据
                    </button>
                </form>
            </div>
        </section>






    </div>

    <!-- 确认对话框 -->
    <div id="confirmModal" class="modal" style="display: none;">
        <div class="modal-content">
            <h3><i class="fas fa-exclamation-triangle"></i> 确认操作</h3>
            <p id="confirmMessage">您确定要执行此操作吗？</p>
            <div class="modal-buttons">
                <button id="confirmYes" class="btn btn-primary">确认</button>
                <button id="confirmNo" class="btn btn-secondary">取消</button>
            </div>
        </div>
    </div>

    <script>
        // 添加全局错误处理
        window.addEventListener('error', function(e) {
            console.error('全局JavaScript错误:', e.error);
            console.error('错误位置:', e.filename, '行:', e.lineno, '列:', e.colno);
        });

        // 页面加载完成后初始化
        document.addEventListener('DOMContentLoaded', function() {
            console.log('DOM内容加载完成，开始初始化...');

            // 添加一个简单的测试来验证JavaScript是否工作
            try {
                document.getElementById('totalMappings').textContent = '测试中...';
                console.log('✅ 基础DOM操作正常');
            } catch (error) {
                console.error('❌ 基础DOM操作失败:', error);
            }

            try {
                console.log('1. 初始化页面...');
                initializePage();

                console.log('2. 设置表单处理器...');
                setupFormHandlers();

                console.log('3. 设置文件上传...');
                setupFileUpload();

                console.log('4. 设置导航...');
                setupNavigation();

                console.log('5. 更新系统状态...');
                updateSystemStatus();

                console.log('6. 启动系统时间更新...');
                startSystemTimeUpdate();



                console.log('页面初始化完成！');
            } catch (error) {
                console.error('页面初始化失败:', error);
                // 显示错误信息到页面上
                const errorDiv = document.createElement('div');
                errorDiv.style.cssText = 'position:fixed;top:10px;right:10px;background:red;color:white;padding:10px;z-index:9999;';
                errorDiv.textContent = '页面初始化失败: ' + error.message;
                document.body.appendChild(errorDiv);
            }
        });

        // 初始化页面
        function initializePage() {
            const currentYear = new Date().getFullYear();
            const currentMonth = (new Date().getMonth() + 1).toString().padStart(2, '0');

            // 设置默认年月
            const yearSelects = document.querySelectorAll('select[name="year"]');
            const monthSelects = document.querySelectorAll('select[name="month"]');

            yearSelects.forEach(select => {
                select.value = currentYear;
            });

            monthSelects.forEach(select => {
                select.value = currentMonth;
            });
        }

        // 设置导航功能
        function setupNavigation() {
            const navItems = document.querySelectorAll('.nav-item');
            const sections = document.querySelectorAll('.module-section');

            navItems.forEach(item => {
                item.addEventListener('click', function() {
                    const targetSection = this.getAttribute('data-section');

                    // 特殊处理统计页面 - 跳转到新页面
                    if (targetSection === 'statistics') {
                        window.open('/statistics', '_blank');
                        return;
                    }



                    // 更新导航状态
                    navItems.forEach(nav => nav.classList.remove('active'));
                    this.classList.add('active');

                    // 显示对应的模块
                    sections.forEach(section => {
                        section.classList.remove('active');
                        if (section.id === targetSection) {
                            section.classList.add('active');
                        }
                    });
                });
            });
        }

        // 更新系统状态
        function updateSystemStatus() {
            const dbStatus = document.getElementById('dbStatus');

            // 检查数据库连接状态
            fetch('/api/system/status')
                .then(response => response.json())
                .then(data => {
                    if (data.database_connected) {
                        dbStatus.className = 'status-indicator online';
                        dbStatus.title = '数据库连接正常';
                    } else {
                        dbStatus.className = 'status-indicator offline';
                        dbStatus.title = '数据库连接异常';
                    }
                })
                .catch(() => {
                    dbStatus.className = 'status-indicator offline';
                    dbStatus.title = '无法获取状态';
                });
        }

        // 开始系统时间更新
        function startSystemTimeUpdate() {
            function updateTime() {
                const now = new Date();
                const timeString = now.getFullYear() + '年' +
                                 String(now.getMonth() + 1).padStart(2, '0') + '月' +
                                 String(now.getDate()).padStart(2, '0') + '日 ' +
                                 String(now.getHours()).padStart(2, '0') + ':' +
                                 String(now.getMinutes()).padStart(2, '0') + ':' +
                                 String(now.getSeconds()).padStart(2, '0');
                document.getElementById('systemTime').textContent = timeString;
            }

            updateTime();
            setInterval(updateTime, 1000);
        }

        // 设置表单处理器
        function setupFormHandlers() {
            // 数据生成表单
            setupLedgerFormSubmit(); // 电子台账使用特殊处理
            setupFormSubmit('summaryForm', '正在生成汇总表...');

            // 数据导入表单
            setupFormSubmit('nationalForm', '正在导入国家点数据...', true);


        }

        // 设置表单提交处理
        function setupFormSubmit(formId, loadingText, needConfirm = false) {
            const form = document.getElementById(formId);
            if (!form) return;

            form.addEventListener('submit', function(e) {
                if (needConfirm) {
                    e.preventDefault();
                    showConfirmDialog(getConfirmMessage(formId), () => {
                        submitForm(form, loadingText);
                    });
                } else {
                    e.preventDefault();
                    submitForm(form, loadingText);
                }
            });
        }

        // 获取确认消息
        function getConfirmMessage(formId) {
            const form = document.getElementById(formId);
            let baseMessage = '';

            const messages = {
                'nationalForm': '确定要导入国家点数据吗？此操作将向数据库添加新记录。'
            };
            baseMessage = messages[formId] || '确定要执行此操作吗？';

            // 检查文件大小并添加警告
            if (form) {
                const fileInput = form.querySelector('input[type="file"]');
                if (fileInput && fileInput.files.length > 0) {
                    const file = fileInput.files[0];
                    const fileSizeMB = file.size / (1024 * 1024);
                    if (fileSizeMB > 10) {
                        baseMessage += `\n\n注意：您选择的文件较大（${fileSizeMB.toFixed(1)}MB），处理时间可能较长，请耐心等待。`;
                    }
                }
            }

            return baseMessage;
        }

        // 提交表单 - 优化版支持异步处理和进度反馈
        function submitForm(form, loadingText) {
            const formId = form.getAttribute('id');
            
            // 检查是否为大文件上传，启用特殊处理
            const fileInput = form.querySelector('input[type="file"]');
            const isLargeFileUpload = fileInput && fileInput.files[0] && fileInput.files[0].size > 10 * 1024 * 1024; // 10MB

            if (formId === 'nationalForm' || isLargeFileUpload) {
                submitFormWithProgress(form, loadingText);
            } else {
                submitFormNormal(form, loadingText);
            }
        }

        // 普通表单提交（保持原有逻辑）
        function submitFormNormal(form, loadingText) {
            showLoading(loadingText);

            const formData = new FormData(form);
            const action = form.getAttribute('action');
            const method = form.getAttribute('method') || 'POST';

            // 创建AbortController用于超时控制
            const controller = new AbortController();
            const timeoutId = setTimeout(() => {
                controller.abort();
            }, 300000); // 5分钟超时

            fetch(action, {
                method: method,
                body: formData,
                signal: controller.signal
            })
            .then(response => {
                // 检查内容类型
                const contentType = response.headers.get('content-type');

                if (contentType && contentType.includes('application/json')) {
                    // 处理JSON响应
                    return response.json().then(data => {
                        showMessage(data.message || '操作完成', data.success ? 'success' : 'error');
                    });
                } else if (contentType && contentType.includes('application/')) {
                    // 处理文件下载
                    if (response.ok) {
                        return response.blob().then(blob => {
                            const url = window.URL.createObjectURL(blob);
                            const a = document.createElement('a');
                            a.href = url;

                            // 尝试从响应头获取文件名
                            let filename = getFileNameFromResponse(response, action);
                            a.download = filename;

                            document.body.appendChild(a);
                            a.click();
                            window.URL.revokeObjectURL(url);
                            document.body.removeChild(a);
                            showMessage('文件生成成功！', 'success');
                        });
                    } else {
                        return response.text().then(text => {
                            showMessage(text || '文件生成失败', 'error');
                        });
                    }
                } else {
                    // 处理文本响应
                    return response.text().then(text => {
                        showMessage(text || (response.ok ? '操作成功' : '操作失败'), response.ok ? 'success' : 'error');
                    });
                }
            })
            .catch(error => {
                clearTimeout(timeoutId);
                if (error.name === 'AbortError') {
                    showMessage('操作超时，请检查文件大小或网络连接', 'error');
                } else {
                    showMessage('网络错误：' + error.message, 'error');
                }
            })
            .finally(() => {
                clearTimeout(timeoutId);
                hideLoading();
            });
        }

        // 带进度的异步表单提交（用于大文件处理）
        function submitFormWithProgress(form, loadingText) {
            const formId = form.getAttribute('id');
            const action = form.getAttribute('action');
            const formData = new FormData(form);

            // 显示带进度的加载状态
            showLoadingWithProgress(loadingText);

            // 启动进度监控
            let progressMonitor = null;
            let completedSuccessfully = false;

            // 提交表单
            fetch(action, {
                method: 'POST',
                body: formData
            })
            .then(async response => {
                const contentType = response.headers.get('content-type');
                
                if (contentType && contentType.includes('application/json')) {
                    const data = await response.json();
                    completedSuccessfully = data.success || response.ok;
                    showMessage(data.message || '操作完成', completedSuccessfully ? 'success' : 'error');
                } else {
                    const text = await response.text();
                    completedSuccessfully = response.ok;
                    showMessage(text || (response.ok ? '操作成功' : '操作失败'), response.ok ? 'success' : 'error');
                }
            })
            .catch(error => {
                completedSuccessfully = false;
                if (error.name === 'AbortError') {
                    showMessage('操作可能因文件过大而超时，但后台仍在处理中', 'warning');
                } else {
                    showMessage('网络错误：' + error.message, 'error');
                }
            })
            .finally(() => {
                if (progressMonitor) {
                    clearInterval(progressMonitor);
                }
                hideLoading();
            });

            // 如果是国家点导入，启动进度监控
            if (formId === 'nationalForm') {
                let progressStep = 0;
                const progressSteps = [
                    '正在读取CSV文件...',
                    '正在验证数据格式...',
                    '正在导入到临时表...',
                    '正在验证数据完整性...',
                    '正在合并到主表...',
                    '正在更新编码信息...',
                    '正在完成最后处理...'
                ];

                progressMonitor = setInterval(() => {
                    if (!completedSuccessfully && progressStep < progressSteps.length - 1) {
                        progressStep++;
                        updateLoadingText(progressSteps[progressStep]);
                    }
                }, 15000); // 每15秒更新一次进度提示
            }
        }

        // 电子台账表单特殊处理（支持进度反馈）
        function setupLedgerFormSubmit() {
            const form = document.getElementById('ledgerForm');
            if (!form) return;

            form.addEventListener('submit', function(e) {
                e.preventDefault();

                const formData = new FormData(form);
                const town = formData.get('town');

                // 生成任务ID
                const taskId = 'ledger_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
                formData.append('task_id', taskId);

                // 确定加载文本
                let loadingText;
                if (town === '全部乡镇') {
                    loadingText = '正在准备批量生成电子台账...';
                } else {
                    loadingText = `正在生成 ${town} 电子台账...`;
                }

                // 显示加载状态
                showLoadingWithProgress(loadingText);

                // 启动进度监控
                const progressMonitor = startLedgerProgressMonitor(taskId, town);

                // 提交表单
                fetch(form.action, {
                    method: 'POST',
                    body: formData
                })
                .then(response => {
                    if (response.ok) {
                        return response.blob().then(blob => {
                            const fileName = getFileNameFromResponse(response, form.action);
                            downloadBlob(blob, fileName);
                            showMessage('电子台账生成成功！', 'success');
                        });
                    } else {
                        return response.text().then(text => {
                            throw new Error(text || '生成失败');
                        });
                    }
                })
                .catch(error => {
                    console.error('电子台账生成失败:', error);
                    showMessage('生成失败：' + error.message, 'error');
                })
                .finally(() => {
                    clearInterval(progressMonitor);
                    hideLoading();
                });
            });
        }

        // 启动电子台账进度监控
        function startLedgerProgressMonitor(taskId, town) {
            return setInterval(() => {
                fetch(`/ledger_progress/${taskId}`)
                .then(response => response.json())
                .then(data => {
                    if (data.success && data.progress) {
                        const progress = data.progress;
                        let progressText;

                        if (progress.status === 'processing') {
                            if (town === '全部乡镇') {
                                progressText = `正在生成 ${progress.current_town} 电子台账... (${progress.current_index}/${progress.total_towns})`;
                            } else {
                                progressText = `正在生成 ${progress.current_town} 电子台账...`;
                            }
                        } else if (progress.status === 'completed') {
                            if (town === '全部乡镇') {
                                progressText = `全部乡镇电子台账生成完成！正在打包下载...`;
                            } else {
                                progressText = `${progress.current_town} 电子台账生成完成！正在准备下载...`;
                            }
                        }

                        updateLoadingText(progressText);
                    }
                })
                .catch(error => {
                    console.warn('获取进度失败:', error);
                });
            }, 2000); // 每2秒检查一次进度
        }

        // 从响应头获取文件名
        function getFileNameFromResponse(response, action) {
            // 尝试从Content-Disposition头获取文件名
            const contentDisposition = response.headers.get('Content-Disposition');
            if (contentDisposition) {
                // 优先匹配 filename*=UTF-8''filename (RFC 5987标准，支持中文)
                const utf8Match = contentDisposition.match(/filename\*=UTF-8''([^;]+)/);
                if (utf8Match) {
                    try {
                        return decodeURIComponent(utf8Match[1]);
                    } catch (e) {
                        console.warn('UTF-8文件名解码失败:', e);
                    }
                }

                // 回退到 filename="filename" (ASCII安全)
                const asciiMatch = contentDisposition.match(/filename="([^"]+)"/);
                if (asciiMatch) {
                    return asciiMatch[1];
                }
            }

            // 回退到默认文件名
            return getDefaultFileName(action);
        }

        // 获取默认文件名
        function getDefaultFileName(action) {

            if (action.includes('ledger')) return '电子台账.xlsx';
            return 'download.xlsx';
        }

        // 设置文件上传
        function setupFileUpload() {
            const fileInputs = document.querySelectorAll('input[type="file"]');

            fileInputs.forEach(input => {
                const label = input.nextElementSibling;

                // 文件选择事件
                input.addEventListener('change', function(e) {
                    const file = e.target.files[0];
                    if (file) {
                        updateFileLabel(label, file);
                        validateFile(file, input);
                    }
                });

                // 拖拽事件
                label.addEventListener('dragover', function(e) {
                    e.preventDefault();
                    label.classList.add('dragover');
                });

                label.addEventListener('dragleave', function(e) {
                    e.preventDefault();
                    label.classList.remove('dragover');
                });

                label.addEventListener('drop', function(e) {
                    e.preventDefault();
                    label.classList.remove('dragover');

                    const files = e.dataTransfer.files;
                    if (files.length > 0) {
                        input.files = files;
                        updateFileLabel(label, files[0]);
                        validateFile(files[0], input);
                    }
                });
            });
        }

        // 更新文件标签
        function updateFileLabel(label, file) {
            const span = label.querySelector('span');
            const small = label.querySelector('small');

            span.textContent = file.name;
            small.textContent = `文件大小: ${formatFileSize(file.size)}`;
            label.classList.add('file-selected');
        }

        // 验证文件
        function validateFile(file, input) {
            const maxSize = 50 * 1024 * 1024; // 50MB
            const fileName = file.name.toLowerCase();
            
            // 根据不同的input确定允许的文件类型
            let allowedTypes;
            if (input.id === 'import_national_file') {
                allowedTypes = ['.csv'];
            } else {
                allowedTypes = ['.xlsx', '.xls'];
            }

            // 检查文件类型
            const isValidType = allowedTypes.some(type => fileName.endsWith(type));

            if (!isValidType) {
                const typeStr = allowedTypes.join(' 或 ');
                showMessage(`文件类型不支持，请选择 ${typeStr} 格式的文件`, 'error');
                input.value = '';
                resetFileLabel(input.nextElementSibling);
                return false;
            }

            // 检查文件大小
            if (file.size > maxSize) {
                showMessage('文件大小超过50MB限制', 'error');
                input.value = '';
                resetFileLabel(input.nextElementSibling);
                return false;
            }

            return true;
        }

        // 重置文件标签
        function resetFileLabel(label) {
            const span = label.querySelector('span');
            const small = label.querySelector('small');
            const input = label.previousElementSibling;
            
            if (input.id === 'import_national_file') {
                span.textContent = '选择CSV文件或拖拽到此处';
                small.textContent = '支持 .csv 格式，最大50MB';
            } else {
                span.textContent = '选择Excel文件或拖拽到此处';
                small.textContent = '支持 .xlsx 和 .xls 格式，最大50MB';
            }
            label.classList.remove('file-selected');
        }

        // 格式化文件大小
        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        // 显示加载状态
        function showLoading(text = '正在处理中...') {
            const overlay = document.getElementById('loadingOverlay');
            const loadingText = document.getElementById('loadingText');
            loadingText.textContent = text;
            overlay.style.display = 'flex';

            // 为导入操作添加超时保护
            if (text.includes('导入')) {
                setTimeout(() => {
                    if (overlay.style.display === 'flex') {
                        loadingText.textContent = text + ' (操作时间较长，请耐心等待...)';
                    }
                }, 10000); // 10秒后显示提示

                setTimeout(() => {
                    if (overlay.style.display === 'flex') {
                        loadingText.textContent = text + ' (大文件处理中，请继续等待...)';
                    }
                }, 30000); // 30秒后显示提示
            }
        }

        // 显示带进度反馈的加载状态（用于大文件处理）
        function showLoadingWithProgress(text = '正在处理中...') {
            const overlay = document.getElementById('loadingOverlay');
            const loadingText = document.getElementById('loadingText');
            
            // 修改加载文本显示，添加进度提示
            loadingText.innerHTML = `
                <div style="text-align: center;">
                    <div style="margin-bottom: 10px;">${text}</div>
                    <div id="progressInfo" style="font-size: 14px; color: #666; margin-top: 10px;">
                        <div>⏱️ 处理大量数据需要时间，请耐心等待</div>
                        <div style="margin-top: 5px;">🔄 系统正在后台处理，不会丢失您的操作</div>
                    </div>
                </div>
            `;
            
            overlay.style.display = 'flex';
        }

        // 更新加载文本
        function updateLoadingText(newText) {
            const loadingText = document.getElementById('loadingText');
            if (loadingText && loadingText.parentElement.style.display === 'flex') {
                // 检查是否是HTML格式（含有div）
                if (loadingText.innerHTML.includes('<div')) {
                    // 更新主要文本，保持进度信息
                    const progressInfo = document.getElementById('progressInfo');
                    if (progressInfo) {
                        loadingText.innerHTML = `
                            <div style="text-align: center;">
                                <div style="margin-bottom: 10px;">${newText}</div>
                                <div id="progressInfo" style="font-size: 14px; color: #666; margin-top: 10px;">
                                    <div>⏱️ 正在执行数据库操作，请继续等待</div>
                                    <div style="margin-top: 5px;">🔍 大数据量处理需要更多时间</div>
                                </div>
                            </div>
                        `;
                    } else {
                        loadingText.textContent = newText;
                    }
                } else {
                    loadingText.textContent = newText;
                }
            }
        }

        // 隐藏加载状态
        function hideLoading() {
            const overlay = document.getElementById('loadingOverlay');
            overlay.style.display = 'none';
        }

        // 显示消息
        function showMessage(message, type = 'info') {
            const container = document.getElementById('messageContainer');
            const messageDiv = document.createElement('div');
            messageDiv.className = `message message-${type}`;

            const icon = type === 'success' ? 'check-circle' :
                        type === 'error' ? 'exclamation-circle' : 
                        type === 'warning' ? 'exclamation-triangle' : 'info-circle';

            messageDiv.innerHTML = `
                <i class="fas fa-${icon}"></i>
                <span>${message}</span>
                <button class="message-close" onclick="this.parentElement.remove()">
                    <i class="fas fa-times"></i>
                </button>
            `;

            container.appendChild(messageDiv);

            // 根据消息类型调整自动移除时间
            const autoRemoveTime = type === 'warning' ? 15000 : 
                                  type === 'error' ? 12000 : 10000;

            // 自动移除消息
            setTimeout(() => {
                if (messageDiv.parentElement) {
                    messageDiv.remove();
                }
            }, autoRemoveTime);
        }

        // 显示确认对话框
        function showConfirmDialog(message, onConfirm) {
            const modal = document.getElementById('confirmModal');
            const messageEl = document.getElementById('confirmMessage');
            const yesBtn = document.getElementById('confirmYes');
            const noBtn = document.getElementById('confirmNo');

            messageEl.textContent = message;
            modal.style.display = 'flex';

            // 移除之前的事件监听器
            const newYesBtn = yesBtn.cloneNode(true);
            const newNoBtn = noBtn.cloneNode(true);
            yesBtn.parentNode.replaceChild(newYesBtn, yesBtn);
            noBtn.parentNode.replaceChild(newNoBtn, noBtn);

            // 添加新的事件监听器
            newYesBtn.addEventListener('click', () => {
                modal.style.display = 'none';
                onConfirm();
            });

            newNoBtn.addEventListener('click', () => {
                modal.style.display = 'none';
            });

            // 点击背景关闭
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    modal.style.display = 'none';
                }
            });
        }











    </script>
</body>
</html>